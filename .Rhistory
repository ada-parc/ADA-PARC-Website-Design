library(leaflet); library(leaflet.extras)
library(tmap); library(tmaptools)
library(htmltools)
library(shiny)
library(shinycssloaders)
# devtools::install_github("daattali/shinycssloaders", ref = "rmarkdown") # rmarkdown branch must be installed and cssloaders_in_header.html must exist
library(shinyWidgets); library(flexdashboard)
library(colourpicker); library(gghighlight)
library(knitr); library(kableExtra)
library(openxlsx); library(scales)
library(hrbrthemes); library(ggthemes)
library(extrafont); library(plotly)
library(mongolite); library(here)
options(scipen = 999999,
tigris_use_cache = TRUE)
knitr::opts_chunk$set(fig.cap = TRUE)
### ----- Database connections -----
# Set this to host_prod or host_dev
host_name = "host_dev"
### ----- Functions import -----
# Load API keys and database connection information
source(here("functions.R"), local = TRUE)
# Load variable dictionary for relating tables, variable codes,
# and readable values
dict_vars <- fun_pull_mongo_data(tables = "dict_vars",
host_name = host_name)
### ----- National Data import and clean -----
# This script takes the national_* objects and transforms them
# into the final datasets for mapping
source(here("national_import.R"), local = TRUE)
tibble::deframe(
dict_location_crosswalk %>%
filter(place_GEOID %in% city_place_full$GEOID) %>%
distinct("GEOID" = place_GEOID, metro_state))
# Pull location crosswalk dictionary from GitHub repo
dict_location_crosswalk <- read_csv("https://raw.githubusercontent.com/sean-connelly/ADA-PARC-Website-Design/master/dictionaries/dict_location_crosswalk.txt")
# Full data for cities in database
city_place_full <- fun_pull_mongo_data(c("S1810", "S1811"),
host_name,
"place")
tibble::deframe(
dict_location_crosswalk %>%
filter(place_GEOID %in% city_place_full$GEOID) %>%
distinct("GEOID" = place_GEOID, metro_state))
# Static check, Chicago
city_place <- city_place_full %>%
filter(GEOID == "1714000")
paste0(
"<h4>",  city_place %>% mutate(NAME = str_replace_all(NAME, pattern = " (city|village|municipality|town), ", replacement = ", ")) %>% pull(NAME), "</h4>",
"Based on ACS 2018 5-Year Estimates, <b>", city_place %>% pull(S1810_C02_001_estimate) %>% scales::comma(.), "</b> of the city's <b>", city_place %>% pull(S1810_C01_001_estimate) %>% scales::comma(.), "</b> residents (<b>", city_place %>% pull(S1810_C03_001_estimate), "%</b>) are people with disabilities.<br><h5>People with Disabilities - Summary Tables</h5>")
city_place %>%
mutate("Other" = S1810_C02_006_estimate + S1810_C02_008_estimate +
S1810_C02_009_estimate + S1810_C02_010_estimate) %>%
select("White" = S1810_C02_011_estimate,
"Black" = S1810_C02_005_estimate,
"Hispanic" = S1810_C02_012_estimate,
"Asian" = S1810_C02_007_estimate,
Other,
"Total" = S1810_C02_001_estimate) %>%
mutate(across(-Total,
~ paste0(comma(., accuracy = 1),
"<br>(",  percent(. / Total,
accuracy = 0.1), ")"))) %>%
mutate(Total = paste0(comma(Total,
accuracy = 1),
"</b>")) %>%
rename("<b>Total" = Total) %>%
pivot_longer(everything(),
names_to = "Race/Ethnicity",
values_to = "PWD (%)")
city_place
city_place %>%
mutate("Other" = S1810_C02_006_estimate + S1810_C02_008_estimate +
S1810_C02_009_estimate + S1810_C02_010_estimate) %>%
select("White" = S1810_C02_011_estimate,
"Black" = S1810_C02_005_estimate,
"Hispanic" = S1810_C02_012_estimate,
"Asian" = S1810_C02_007_estimate,
Other,
"Total" = S1810_C02_001_estimate) %>%
mutate(across(-Total,
~ paste0(comma(., accuracy = 1),
"<br>(",  percent(. / Total,
accuracy = 0.1), ")"))) %>%
mutate(Total = paste0(comma(Total,
accuracy = 1),
"</b>")) %>%
rename("<b>Total" = Total) %>%
pivot_longer(everything(),
names_to = "Race/Ethnicity",
values_to = "PWD (%)")
# Demographics
city_summary_demo <- city_place %>%
mutate("Other" = S1810_C02_006_estimate + S1810_C02_008_estimate +
S1810_C02_009_estimate + S1810_C02_010_estimate) %>%
select("White" = S1810_C02_011_estimate,
"Black" = S1810_C02_005_estimate,
"Hispanic" = S1810_C02_012_estimate,
"Asian" = S1810_C02_007_estimate,
Other,
"Total" = S1810_C02_001_estimate) %>%
mutate(across(-Total,
~ paste0(comma(., accuracy = 1),
" (",  percent(. / Total,
accuracy = 0.1), ")"))) %>%
mutate(Total = paste0(comma(Total,
accuracy = 1),
"</b>")) %>%
rename("<b>Total" = Total) %>%
pivot_longer(everything(),
names_to = "Race/Ethnicity",
values_to = "PWD (%)")
# Community Participation
city_summary_cp <- city_place %>%
transmute("Car" =
paste0(comma(S1811_C02_032_estimate *
(S1811_C02_033_estimate +
S1811_C02_034_estimate),
accuracy = 1),
" (", comma((S1811_C02_033_estimate +
S1811_C02_034_estimate),
accuracy = 0.1), "%)"),
"Transit" =
paste0(comma(S1811_C02_032_estimate *
(S1811_C02_035_estimate),
accuracy = 1),
" (", comma(S1811_C02_035_estimate,
accuracy = 0.1), "%)"),
"Walk or Bike" =
paste0(comma(S1811_C02_032_estimate *
(S1811_C02_036_estimate +
S1811_C02_037_estimate),
accuracy = 1),
" (", comma((S1811_C02_036_estimate +
S1811_C02_037_estimate),
accuracy = 0.1), "%)"),
"Work from Home" =
paste0(comma(S1811_C02_032_estimate *
(S1811_C02_038_estimate),
accuracy = 1),
" (", comma((S1811_C02_038_estimate),
accuracy = 0.1), "%)"),
"<b>Total" =
paste0(comma(S1811_C02_032_estimate,
accuracy = 1),
"</b>")) %>%
pivot_longer(everything(),
names_to = "Commute, Workers 16+",
values_to = "PWD (%)")
# Work/Economic
city_summary_we <- city_place %>%
transmute("Employed" =
paste0(comma(S1811_C02_004_estimate, accuracy = 1),
" (", S1811_C02_002_estimate, "%)"),
"Not in Labor Force" =
paste0(comma((S1811_C02_001_estimate - S1811_C02_004_estimate), accuracy = 1),
" (", S1811_C02_003_estimate, "%)"),
"<b>Total" =
paste0(comma(S1811_C02_001_estimate, accuracy = 1),
"</b>")) %>%
pivot_longer(everything(),
names_to = "Employment, 16+",
values_to = "PWD (%)")
# SUmmary text
city_summary_text <- paste0(
"<h4>",  city_place %>% mutate(NAME = str_replace_all(NAME, pattern = " (city|village|municipality|town), ", replacement = ", ")) %>% pull(NAME), "</h4>",
"Based on ACS 2018 5-Year Estimates, <b>", city_place %>% pull(S1810_C02_001_estimate) %>% scales::comma(.), "</b> of the city's <b>", city_place %>% pull(S1810_C01_001_estimate) %>% scales::comma(.), "</b> residents (<b>", city_place %>% pull(S1810_C03_001_estimate), "%</b>) are people with disabilities.<br><h5>People with Disabilities - Summary Tables</h5>")
# Create individual summary tables
# Demographics
city_summary_demo <- city_place %>%
mutate("Other" = S1810_C02_006_estimate + S1810_C02_008_estimate +
S1810_C02_009_estimate + S1810_C02_010_estimate) %>%
select("White" = S1810_C02_011_estimate,
"Black" = S1810_C02_005_estimate,
"Hispanic" = S1810_C02_012_estimate,
"Asian" = S1810_C02_007_estimate,
Other,
"Total" = S1810_C02_001_estimate) %>%
mutate(across(-Total,
~ paste0(comma(., accuracy = 1),
" (",  percent(. / Total,
accuracy = 0.1), ")"))) %>%
mutate(Total = paste0(comma(Total,
accuracy = 1),
"</b>")) %>%
rename("<b>Total" = Total) %>%
pivot_longer(everything(),
names_to = "Race/Ethnicity",
values_to = "PWD (%)")
# Community Participation
city_summary_cp <- city_place %>%
transmute("Car" =
paste0(comma(S1811_C02_032_estimate *
(S1811_C02_033_estimate +
S1811_C02_034_estimate),
accuracy = 1),
" (", comma((S1811_C02_033_estimate +
S1811_C02_034_estimate),
accuracy = 0.1), "%)"),
"Transit" =
paste0(comma(S1811_C02_032_estimate *
(S1811_C02_035_estimate),
accuracy = 1),
" (", comma(S1811_C02_035_estimate,
accuracy = 0.1), "%)"),
"Walk or Bike" =
paste0(comma(S1811_C02_032_estimate *
(S1811_C02_036_estimate +
S1811_C02_037_estimate),
accuracy = 1),
" (", comma((S1811_C02_036_estimate +
S1811_C02_037_estimate),
accuracy = 0.1), "%)"),
"Work from Home" =
paste0(comma(S1811_C02_032_estimate *
(S1811_C02_038_estimate),
accuracy = 1),
" (", comma((S1811_C02_038_estimate),
accuracy = 0.1), "%)"),
"<b>Total" =
paste0(comma(S1811_C02_032_estimate,
accuracy = 1),
"</b>")) %>%
pivot_longer(everything(),
names_to = "Commute, Workers 16+",
values_to = "PWD (%)")
# Work/Economic
city_summary_we <- city_place %>%
transmute("Employed" =
paste0(comma(S1811_C02_004_estimate, accuracy = 1),
" (", S1811_C02_002_estimate, "%)"),
"Not in Labor Force" =
paste0(comma((S1811_C02_001_estimate - S1811_C02_004_estimate), accuracy = 1),
" (", S1811_C02_003_estimate, "%)"),
"<b>Total" =
paste0(comma(S1811_C02_001_estimate, accuracy = 1),
"</b>")) %>%
pivot_longer(everything(),
names_to = "Employment, 16+",
values_to = "PWD (%)")
# Place dataframes in 3 columns side-by-side
city_summary_tables <- paste0('<div class = "row">',
'<div class = "col-md-4">',
city_summary_demo,
'</div>',
'<div class = "col-md-4">',
city_summary_cp,
'</div>',
'<div class = "col-md-4">',
city_summary_we,
'</div>',
'</div>')
city_summary_tables
# UI Output
HTML(paste(city_summary_text, city_summary_tables, sep = "<br>"))
city_place %>%
mutate("Other" = S1810_C02_006_estimate + S1810_C02_008_estimate +
S1810_C02_009_estimate + S1810_C02_010_estimate) %>%
select("White" = S1810_C02_011_estimate,
"Black" = S1810_C02_005_estimate,
"Hispanic" = S1810_C02_012_estimate,
"Asian" = S1810_C02_007_estimate,
Other,
"Total" = S1810_C02_001_estimate) %>%
mutate(across(-Total,
~ paste0(comma(., accuracy = 1),
" (",  percent(. / Total,
accuracy = 0.1), ")"))) %>%
mutate(Total = paste0(comma(Total,
accuracy = 1),
"</b>")) %>%
rename("<b>Total" = Total) %>%
pivot_longer(everything(),
names_to = "Race/Ethnicity",
values_to = "PWD (%)")
city_place %>%
mutate("Other" = S1810_C02_006_estimate + S1810_C02_008_estimate +
S1810_C02_009_estimate + S1810_C02_010_estimate) %>%
select("White" = S1810_C02_011_estimate,
"Black" = S1810_C02_005_estimate,
"Hispanic" = S1810_C02_012_estimate,
"Asian" = S1810_C02_007_estimate,
Other,
"Total" = S1810_C02_001_estimate) %>%
mutate(across(-Total,
~ paste0(comma(., accuracy = 1),
" (",  percent(. / Total,
accuracy = 0.1), ")"))) %>%
mutate(Total = paste0(comma(Total,
accuracy = 1),
"</b>")) %>%
rename("<b>Total" = Total) %>%
pivot_longer(everything(),
names_to = "Race/Ethnicity",
values_to = "PWD (%)") %>%
mutate("Bullets" = paste0('<li>', `Race/Ethnicity`, ": ",
`PWD (%)`, '</li>', collapse = "")) %>%
pull(Bullets)
city_place %>%
mutate("Other" = S1810_C02_006_estimate + S1810_C02_008_estimate +
S1810_C02_009_estimate + S1810_C02_010_estimate) %>%
select("White" = S1810_C02_011_estimate,
"Black" = S1810_C02_005_estimate,
"Hispanic" = S1810_C02_012_estimate,
"Asian" = S1810_C02_007_estimate,
Other,
"Total" = S1810_C02_001_estimate) %>%
mutate(across(-Total,
~ paste0(comma(., accuracy = 1),
" (",  percent(. / Total,
accuracy = 0.1), ")"))) %>%
mutate(Total = paste0(comma(Total,
accuracy = 1),
"</b>")) %>%
rename("<b>Total" = Total) %>%
pivot_longer(everything(),
names_to = "Race/Ethnicity",
values_to = "PWD (%)") %>%
mutate("Bullets" = paste0('<li>', `Race/Ethnicity`, ": ",
`PWD (%)`, '</li>')) %>%
pull(Bullets)
city_place %>%
mutate("Other" = S1810_C02_006_estimate + S1810_C02_008_estimate +
S1810_C02_009_estimate + S1810_C02_010_estimate) %>%
select("White" = S1810_C02_011_estimate,
"Black" = S1810_C02_005_estimate,
"Hispanic" = S1810_C02_012_estimate,
"Asian" = S1810_C02_007_estimate,
Other,
"Total" = S1810_C02_001_estimate) %>%
mutate(across(-Total,
~ paste0(comma(., accuracy = 1),
" (",  percent(. / Total,
accuracy = 0.1), ")"))) %>%
mutate(Total = paste0(comma(Total,
accuracy = 1),
"</b>")) %>%
rename("<b>Total" = Total) %>%
pivot_longer(everything(),
names_to = "Race/Ethnicity",
values_to = "PWD (%)") %>%
mutate("Bullets" = paste0('<li>', `Race/Ethnicity`, ": ",
`PWD (%)`, '</li>')) %>%
pull(Bullets) %>%
collapse()
city_place %>%
mutate("Other" = S1810_C02_006_estimate + S1810_C02_008_estimate +
S1810_C02_009_estimate + S1810_C02_010_estimate) %>%
select("White" = S1810_C02_011_estimate,
"Black" = S1810_C02_005_estimate,
"Hispanic" = S1810_C02_012_estimate,
"Asian" = S1810_C02_007_estimate,
Other,
"Total" = S1810_C02_001_estimate) %>%
mutate(across(-Total,
~ paste0(comma(., accuracy = 1),
" (",  percent(. / Total,
accuracy = 0.1), ")"))) %>%
mutate(Total = paste0(comma(Total,
accuracy = 1),
"</b>")) %>%
rename("<b>Total" = Total) %>%
pivot_longer(everything(),
names_to = "Race/Ethnicity",
values_to = "PWD (%)") %>%
mutate("Bullets" = paste0('<li>', `Race/Ethnicity`, ": ",
`PWD (%)`, '</li>')) %>%
collapse(Bullets)
city_place %>%
mutate("Other" = S1810_C02_006_estimate + S1810_C02_008_estimate +
S1810_C02_009_estimate + S1810_C02_010_estimate) %>%
select("White" = S1810_C02_011_estimate,
"Black" = S1810_C02_005_estimate,
"Hispanic" = S1810_C02_012_estimate,
"Asian" = S1810_C02_007_estimate,
Other,
"Total" = S1810_C02_001_estimate) %>%
mutate(across(-Total,
~ paste0(comma(., accuracy = 1),
" (",  percent(. / Total,
accuracy = 0.1), ")"))) %>%
mutate(Total = paste0(comma(Total,
accuracy = 1),
"</b>")) %>%
rename("<b>Total" = Total) %>%
pivot_longer(everything(),
names_to = "Race/Ethnicity",
values_to = "PWD (%)") %>%
mutate("Bullets" = paste0('<li>', `Race/Ethnicity`, ": ",
`PWD (%)`, '</li>')) %>%
pull(Bullets) %>%
str_c(collapse = "")
View(city_place)
city_place %>% select(S1811_C02_032_estimate:S1811_C02_038_estimate)
View(city_place_full)
test <- city_place_full %>%
filter(GEOID == "0151000")
select(S1811_C02_032_estimate:S1811_C02_038_estimate)
View(test)
test <- city_place_full %>%
filter(GEOID == "0151000") %>%
select(S1811_C02_032_estimate:S1811_C02_038_estimate)
city_place_full %>%
filter(GEOID == "0151000") %>%
select(S1811_C02_032_estimate:S1811_C02_038_estimate) %>%
transmute("Car" =
paste0(comma((S1811_C02_032_estimate *
(S1811_C02_033_estimate +
S1811_C02_034_estimate)),
accuracy = 1),
" (", comma((S1811_C02_033_estimate +
S1811_C02_034_estimate),
accuracy = 0.1), "%)"),
"Transit" =
paste0(comma((S1811_C02_032_estimate *
(S1811_C02_035_estimate)),
accuracy = 1),
" (", comma(S1811_C02_035_estimate,
accuracy = 0.1), "%)"),
"Walk or Bike" =
paste0(comma((S1811_C02_032_estimate *
(S1811_C02_036_estimate +
S1811_C02_037_estimate)),
accuracy = 1),
" (", comma((S1811_C02_036_estimate +
S1811_C02_037_estimate),
accuracy = 0.1), "%)"),
"Work from Home" =
paste0(comma(S1811_C02_032_estimate *
(S1811_C02_038_estimate),
accuracy = 1),
" (", comma((S1811_C02_038_estimate),
accuracy = 0.1), "%)"),
"<b>Total" =
paste0(comma(S1811_C02_032_estimate,
accuracy = 1),
"</b>"))
city_place() %>%
test <- city_place_full %>%
filter(GEOID == "0151000") %>%
select(S1811_C02_032_estimate:S1811_C02_038_estimate) %>%
mutate("Car" = (S1811_C02_032_estimate *
(S1811_C02_033_estimate +
S1811_C02_034_estimate))
city_place_full %>%
filter(GEOID == "0151000") %>%
select(S1811_C02_032_estimate:S1811_C02_038_estimate) %>%
mutate("Car" = (S1811_C02_032_estimate *
(S1811_C02_033_estimate +
S1811_C02_034_estimate)))
city_place_full %>%
filter(GEOID == "0151000") %>%
select(S1811_C02_032_estimate:S1811_C02_038_estimate) %>%
mutate("Car" = (S1811_C02_032_estimate *
(S1811_C02_033_estimate +
S1811_C02_034_estimate)))
city_place_full %>%
filter(GEOID == "0151000") %>%
select(S1811_C02_032_estimate:S1811_C02_038_estimate) %>%
mutate("Car" = (S1811_C02_032_estimate *
((S1811_C02_033_estimate +
S1811_C02_034_estimate)/100))
city_place_full %>%
filter(GEOID == "0151000") %>%
select(S1811_C02_032_estimate:S1811_C02_038_estimate) %>%
mutate("Car" = (S1811_C02_032_estimate *
((S1811_C02_033_estimate +
S1811_C02_034_estimate)/100)))
city_place_full %>%
filter(GEOID == "0151000") %>%
select(S1811_C02_032_estimate:S1811_C02_038_estimate) %>%
mutate("Car" = (S1811_C02_032_estimate *
((S1811_C02_033_estimate +
S1811_C02_034_estimate)/100)))
city_place_full %>%
filter(GEOID == "0151000") %>%
select(S1811_C02_032_estimate:S1811_C02_038_estimate) %>%
transmute("Car" =
paste0(comma(S1811_C02_032_estimate *
((S1811_C02_033_estimate +
S1811_C02_034_estimate) / 100),
accuracy = 1),
" (", comma((S1811_C02_033_estimate +
S1811_C02_034_estimate),
accuracy = 0.1), "%)"),
"Transit" =
paste0(comma(S1811_C02_032_estimate *
(S1811_C02_035_estimate / 100),
accuracy = 1),
" (", comma(S1811_C02_035_estimate,
accuracy = 0.1), "%)"),
"Walk or Bike" =
paste0(comma(S1811_C02_032_estimate *
((S1811_C02_036_estimate +
S1811_C02_037_estimate) / 100),
accuracy = 1),
" (", comma((S1811_C02_036_estimate +
S1811_C02_037_estimate),
accuracy = 0.1), "%)"),
"Work from Home" =
paste0(comma(S1811_C02_032_estimate *
(S1811_C02_038_estimate / 100),
accuracy = 1),
" (", comma((S1811_C02_038_estimate),
accuracy = 0.1), "%)"),
"<b>Total" =
paste0(comma(S1811_C02_032_estimate,
accuracy = 1),
"</b>")) %>%
pivot_longer(everything(),
names_to = "Commute, Workers 16+",
values_to = "PWD (%)")
