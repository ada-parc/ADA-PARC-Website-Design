---
title: "ADA-PARC Census Database Builder Tool"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    code_folding: hide
editor_options: 
  chunk_output_type: console
runtime: shiny
---

```{r setup, include=FALSE}

# Libraries
library(tidyverse);library(readxl)
library(tigris);library(sf);library(janitor)
library(tidycensus);library(viridis);library(tmap)
library(RPostgres);library(RPostgreSQL);library(DBI)
library(geojsonsf);library(mongolite)
library(shiny); library(shinyWidgets)

# Set working document, options
setwd(here::here())
options(scipen = 999, dplyr.summarise.inform = FALSE, tigris_use_cache = TRUE)
knitr::opts_chunk$set(echo = FALSE)

# Load API keys and database connection information
source("secret.R", local = TRUE)

```

### Background

This interactive walkthrough tool allows users to upload specific American Community Survey (ACS) data related to people with disabilities to the MongoDB database powering the [ADA-PARC Data Dashboard](https://ada-parc.shinyapps.io/ada_parc/). The rest of the document is organized by the various geographies used in the ADA-PARC dashboard: States, Cities (or Places), and Tracts.

### States

#### Select ACS Components

Use the following inputs to download ACS data at the state level. This script uses Kyle Walker's tidycensus package to access US Census Bureau APIs. Please consult the [tidycensus documentation](https://cran.r-project.org/web/packages/tidycensus/tidycensus.pdf) for additional information and options. 

```{r states-input}

# Dataset
selectInput(inputId = "states_acs_dataset",
            label = "Select a dataset:",
            choices = list(`5-Year ACS` = list("Default (Detailed)" = "acs5",
                                               "Subject" = "acs5/subject", 
                                               "Profile" = "acs5/profile"),
                           `3-Year ACS` = list("Default (Detailed)" = "acs3",
                                               "Subject" = "acs3/subject", 
                                               "Profile" = "acs3/profile"),
                           `1-Year ACS` = list("Default (Detailed)" = "acs1",
                                               "Subject" = "acs1/subject", 
                                               "Profile" = "acs1/profile"),
                           `Summary File` = list("3-Year" = "sf3", 
                                                 "1-Year" = "sf1")),
            selected = "acs5/subject")

# Year
selectInput(inputId = "states_acs_year",
            label = "Select a data endpoint year:",
            choices = c(2005:2019),
            selected = 2019)

# variables for selection
states_acs_vars_ref <- reactive({
  
  load_variables(year = input$states_acs_year,
                 dataset =  input$states_acs_dataset, 
                 cache = TRUE) %>% 
    filter(!is.na(concept)) %>% 
    mutate(table_name = gsub( "_.*$", "", name),
           label = gsub("!!", "; ", label),
           shiny_input_label = paste0(table_name, ": ", str_to_title(concept)))
  
})

# # Static check
# states_acs_vars_ref <- load_variables(year = 2019,
#                                       dataset = "acs5/subject", 
#                                       cache = TRUE) %>% 
#   filter(!is.na(concept)) %>% 
#   mutate(table_name = gsub( "_.*$", "", name),
#          label = gsub("!!", "; ", label),
#          shiny_input_label = paste0(table_name, ": ", str_to_title(concept)))

# Tables
selectizeInput(inputId = "states_acs_tables",
               label = "Select one or more tables to download:",
               choices = unique(states_acs_vars_ref()$table_name),
               selected = c("S1810", "S1811", "S2601A", "S2602"),
               multiple = TRUE)

states_acs_tables %>% filter(str_detect(name, pattern = "(^S181(0|1)_*)|(^S26(01A|02)_*)"))
# Filter variables based on table selection 
states_acs_vars_selected <- reactive({
  
  states_acs_vars_ref %>%
    filter(table_name %in% input$states_acs_tables) %>%
    filter(!str_detect(label, pattern = "DISABILITY TYPE BY DETAILED AGE")) %>% # Removes detailed age data
    mutate(table_name = gsub( "_.*$", "", name),
           label = gsub("!!", "; ", label))

  })

```


```{r states-output}

# State data selected
DT::renderDataTable({ datatable(states_acs_vars_selected()) %>% head(5) })


```

### Cities

#### Select ACS Components

You can also embed plots, for example:

#### Select Cities (Census-Defined Places) 

```{r cities-location-input}

# most_populated <- get_estimates(geography = "place",
#                                 year = 2018,
#                                 product = "population",
#                                 geometry = FALSE,
#                                 output = "wide") %>% 
#   arrange(desc(POP)) %>% 
#   head(200)

```
