---
title: "ADA-PARC"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: cosmo
---

```{r setup, include=FALSE}

# ====================
# Setup
# ====================

# Packages
library(tidyverse)
library(sf)
library(geofacet)
library(leaflet); library(leaflet.extras);
library(htmltools)
library(shiny)
library(shinyWidgets)
library(flexdashboard)
library(colourpicker)
library(gghighlight)
library(knitr)
library(kableExtra)
library(scales)
library(hrbrthemes)
library(ggthemes)
library(extrafont)
library(plotly)
library(mongolite)
library(here)

options(scipen = 999999)

# Set this to host_prod or host_dev
host_name = "host_dev"

# Load API keys and database connection information
source(here("functions.R"), local = TRUE)

# Load variable dictionary for relating tables, variable codes, and readable values
dict_vars <- fun_pull_mongo_data(tables = "dict_vars", host_name = host_name)


### ------------------------
### National data import and clean
###
# This script takes the national_* objects and transforms them
# into the final datasets for mapping
source(here("national_import.R"), local = TRUE)

```

# Home

## Sidebar {.sidebar}

<br>

#### How to Navigate<br>this Website

<br>

Use the **National** tab to examine the status of people with disabilities at the national and state level.

Use the **By Metro** tab to investigate people with disabilities statistics at the municipal level.

Use the **Download** tab to get the raw data powering this dashboard and as well as pre-formatted fact sheets a specific area of interest.

Use the **Accessibility** tab to set color palettes for the visualizations in this dashboard.

<br>

Application authors:

Sean Connelly and Ethan Jantz <br> [UIC Voorhees Center](https://voorheescenter.uic.edu/)

## Row

### 

<br>

Welcome to the ADA-PARC website. The ADA-PARC is a collaborative research project of ten Americans with Disabilities Act (ADA) Regional Centers.

<br>

#### Purpose of ADA-PARC

The ADA-PARC research has four purposes:

1.  **To look at participation disparities** experienced by people with disabilities post ADA & Olmstead
2.  **To identify & examine key environmental factors** contributing to these disparities
3.  **To benchmark participation disparities and highlight promising practices** at state & city levels
4.  **To action-plan strategies for dissemination and utilization of findings** to be used by ADA Centers and others in community capacity building & systems change initiatives

<br>

#### The Work of the ADA-PARC

The ADA-PARC has research teams focused on Community Living, Community Participation & Work/Economic Participation measures and uses Regional Steering Committees in each of the ten participating regions to gather, review, and choose appropriate data to achieve the project's purposes. The data are mainly from national data sources that have enough statistical power to be relevant on the local level.

The intent of this effort is to use this information to inform:

1.  ADA Center technical assistance and resource dissemination, and
2.  Community level stakeholders to increase participation opportunities in their communities.

<br>

#### Who is the ADA-PARC

The ten participating ADA-Regional Centers in the ADA-PARC are:

-   Region 1 New England ADA Center
-   Region 2 Northeast ADA Center
-   Region 3 Mid-Atlantic ADA Center
-   Region 4 Southeast ADA Center
-   Region 5 Great Lakes ADA Center
-   Region 6 Southwest ADA Center
-   Region 7 Great Plains ADA Center
-   Region 8 Rocky Mountain ADA Center
-   Region 9 Pacific ADA Center
-   Region 10 Great Northwest ADA Center

Other institutions collaborating in the ADA-PARC are:

-   The ADA Knowledge Translation Center
-   The Center on Disability at the Public Health Institute
-   TIRR Memorial Hermann
-   Syracuse University
-   The University of Illinois at Chicago
-   The University of Northern Colorado

<br>

![ADA-PARC Participants](./participant_logos.png){width="75%"}

<br>

#### About this Website

The ADA-PARC website is a collection of public data sets that can help shed light on the status of people with disabilities in local communities. The data includes national, state, county, and city data. In addition to Demographic data describing the population, the three main areas of data to illuminate the status of disability in an area are: Community Living, Community Participation and Work & Economics. Each of the three areas presents data in map form as well as in tabular form. A summary of what is important about the data is presented on each page. The data source is described along with the calculation to arrive at the values used in the tables and maps. Data is first presented by state, and then if available, at county and city level.

# National Data

## Sidebar {.sidebar}

<br>

```{r national_sidebar, message=FALSE, warning=FALSE}

# Select the dataset to use
selectInput(inputId = "national_category_selector", 
            label = "Select a category", 
            choices = c("Demographics" = "is_demographics", 
                        "Community Participation" = "is_community_participation", 
                        "Community Living" = "is_community_living", 
                        "Work/Economic" = "is_work_economic"),
            selected = NULL)

# Initializes the variable selector
# no choices until national_category_selector is selected
selectInput(inputId = "national_variable_selector",
            label = "Select a topic",
            choices = NULL,
            selected = "Total Population")


# Update select dropdown with named list of values created above
observeEvent(input$national_category_selector,
             
             {
               
               updateSelectInput(session,
                                 input = "national_variable_selector",
                                 choices = national_variable_choices(),
                                 selected = NULL)
               
             }
             
)

# Set national df by input$national_category_selector, which returns a string
# eval() evaluates a symbol created by sym(input)
# returns a df with the same name as the string 
# "is_[table]" refers to a column in the variable dictionary
# that denotes which table a variable belongs to
national_data <- reactive({
  eval(sym(str_remove(input$national_category_selector, "^is_")))
})

# Create reactive named list of choices based on national_category_selector
national_variable_choices <- reactive({
  
  tibble::deframe(
    dict_vars %>% 
      filter((!!sym(input$national_category_selector)) == TRUE, # "is_[table]" is TRUE/FALSE
             var_readable %in% ( # var_readable looks like "pwd_pct"
               national_data() %>%
                 select(-c(GEOID, NAME, ABBR)) %>%
                 names()
             ),
             !is.na(national_dropdown_label)) %>% # national_dropdown_label looks like "Percentage of People With Disabilities"
      select(national_dropdown_label, var_readable))
    
    # # Static check
    # tibble::deframe(
    # dict_vars %>%
    #   filter(is_work_economic == T,
    #          var_readable %in% (
    #            work_economic %>%
    #              select(-c(GEOID, NAME, ABBR)) %>%
    #              names()
    #          ),
    #          !is.na(national_dropdown_label)) %>%
    #   select(national_dropdown_label, var_readable))
    
})

# You can use this chunk of code to test whether a selector is working
# as intended. Here the intention is to have the input return a string.
# Uncommenting this code puts a small message beneath the selectors in 
# the sidebar showeing the result. 
# output$check <- renderText({
#   cap_choices <- c("Demographics" = "is_demographics", 
#                         "Community Participation" = "is_community_participation", 
#                         "Community Living" = "is_community_living", 
#                         "Work/Economic" = "is_work_economic")
#   
#   paste0("national_category is: ", names(cap_choices)[cap_choices == input$national_category_selector], 
#          "\n and national_variable is: ", input$national_variable_selector)
# })
# # 
# textOutput("check")

# national_variable <- reactive({ input$national_variable_selector })

output$alt_text <- renderText ({ altText(national_data(), input$national_variable_selector) })

```

## Row

### Map

```{r, national_map, fig.alt = textOutput("alt_text")}

renderPlot({
  
  req(input$national_variable_selector)
  
  render_tile_map(national_data(), 
                  input$national_variable_selector, 
                  input$access_map_palette)
  
})

```

### Table {.table-wrapper}

```{r, national_table}

  
# Get variable group based on selected variable
national_vars_in_topic <- reactive({
  
  dict_vars %>% 
    filter((!!sym(input$national_category_selector)) == TRUE,
           var_topic ==
             (dict_vars %>% 
                filter(var_readable == input$national_variable_selector) %>% 
                pull(var_topic))) %>% 
    pull(var_readable)

  
})

renderUI({
  
  cap_choices <- c("Demographics" = "is_demographics", 
                   "Community Participation" = "is_community_participation", 
                   "Community Living" = "is_community_living", 
                   "Work/Economic" = "is_work_economic")
  
  table_caption <- paste(names(cap_choices[cap_choices == input$national_category_selector]), "Table")
  
  # Reorganize dataframe
  national_data <- national_data() %>%
    select(GEOID:ABBR, national_vars_in_topic())
  
  # Summary table
  national_topic_table <- knitr::kable(x = national_data,
                                       caption = table_caption) %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                    position = "left")
  
  # UI Output
  HTML(national_topic_table)
  
})

# renderPrint({  national_vars_in_topic() })
# Data table
# DT::renderDataTable({
# 
#   # Reorganize dataframe
#   national_data <- national_data() %>%
#     select(GEOID:ABBR, national_vars_in_topic())
# 
#   # Table
#   DT::datatable(national_data,
#                 rownames = FALSE,
#                 fillContainer = TRUE,
#                 extensions = c("Buttons"),
#                 options = list(pageLength = -1,
#                                searching = TRUE,
#                                scrollY = "100vh",
#                                scrollX = "100px",
#                                dom = "Bfti",
#                                # https://datatables.net/reference/option/dom
#                                buttons = c("copy", "csv", "excel")))
# })
# 
# DT::dataTableOutput("national_data")

```

# Metropolitan Data

## Sidebar {.sidebar}

<br>

```{r metro snapshot input}

# Pull location crosswalk dictionary from GitHub repo
dict_location_crosswalk <- read_csv("https://raw.githubusercontent.com/sean-connelly/ADA-PARC-Website-Design/master/dictionaries/dict_location_crosswalk.txt")

# Full data for cities in database
metro_snapshot_place_full <- fun_pull_mongo_data(c("S1810", "S1811"), 
                                                 host_name, 
                                                 "place")

# Define inputs, restrict to cities in database
selectInput(inputId = "metro_snapshot", 
            label = "Select a City or Town", 
            choices = tibble::deframe(
              dict_location_crosswalk %>% 
                filter(place_GEOID %in% metro_snapshot_place_full$GEOID) %>% 
                distinct("GEOID" = place_GEOID, metro_state))
            )

# ===============
# Pull Census place data
# ===============

# Place for selected metro
metro_snapshot_place <- reactive({
  
  metro_snapshot_place_full %>% 
    filter(GEOID == input$metro_snapshot)
  
})

# ===============
# Pull Census tract data for selected metro
# ===============

# Spatial
metro_snapshot_tract_sf <- reactive({
  
  # Restrict tract call to selected cities
  temp_metro <- dict_location_crosswalk %>% 
    filter(place_GEOID %in% c(input$metro_snapshot)) %>% 
    pull(tract_GEOID)
  
  # Connect and pull
  temp_mongo_conn <- fun_mongo_connect(host_name,
                                       collection_name = "geo_tract",
                                       database_name = "ADA-PARC")
  temp_geo <- temp_mongo_conn$iterate(
    query = sprintf('{ "properties.GEOID" : { "$in" : [  "%s" ] } }' ,
                    str_c(temp_metro, collapse = '", "')))
  temp_sf <- geojsonsf::geojson_sf(temp_geo$json(size = 100000))
  return(temp_sf)
  
})

# Tabular
metro_snapshot_tract <- reactive ({
  
  # Connect and pull
  temp_mongo_conn <- fun_mongo_connect(host_name,
                                       collection_name = "acs_tract_S1810",
                                       database_name = "ADA-PARC")
  temp <- temp_mongo_conn$find(
    query = sprintf('{ "GEOID" : { "$in" : [  "%s" ] } }' ,
                    str_c(metro_snapshot_tract_sf()$GEOID, collapse = '", "')))
  return(temp)
  
})

```

## Row

### Overview

```{r metro snapshot overview text}

renderUI({
  
  # Overview text  
  metro_snap_overview_text <- paste0(
    "<h4>",  metro_snapshot_place() %>% mutate(NAME = str_replace_all(NAME, pattern = " (city|village|municipality|town), ", replacement = ", ")) %>% pull(NAME), "</h4>", # "<br>",
    "Based on ACS 2018 5-Year Estimates, <b>", metro_snapshot_place() %>% pull(S1810_C02_001_estimate) %>% scales::comma(.), "</b> of the city's <b>", metro_snapshot_place() %>% pull(S1810_C01_001_estimate) %>% scales::comma(.), "</b> residents (<b>", metro_snapshot_place() %>% pull(S1810_C03_001_estimate), "%</b>) are people with disabilities.<br><h5>People with Disabilities - Summary Tables</h5>")
  
  # Summary tables side by side
  metro_snap_tables <- knitr::kables(list(
    
    # Demographics
    kbl(x = metro_snapshot_place() %>%
          mutate("Other" = S1810_C02_006_estimate + S1810_C02_008_estimate + 
                   S1810_C02_009_estimate + S1810_C02_010_estimate) %>% 
          select("White" = S1810_C02_011_estimate,
                 "Black" = S1810_C02_005_estimate,
                 "Hispanic" = S1810_C02_012_estimate,
                 "Asian" = S1810_C02_007_estimate,
                 Other,
                 "Total" = S1810_C02_001_estimate) %>% 
          mutate(across(-Total,
                        ~ paste0(comma(., accuracy = 1), 
                                 "<br>(",  percent(. / Total, 
                                                   accuracy = 0.1), ")"))) %>%
          mutate(Total = paste0(comma(Total, 
                                      accuracy = 1),
                                "</b>")) %>%
          rename("<b>Total" = Total) %>% 
          pivot_longer(everything(),
                       names_to = "Race/Ethnicity",
                       values_to = "PWD (%)"),
        caption = "Race/Ethnicity",
        escape = FALSE,
        align = c("l", "r") #,
        # table.attr = "style='width:80%;'"
    ) %>% 
      kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                    position = "left"),
    
    # Community Participation
    kbl(x = metro_snapshot_place() %>%
          transmute("Car" = 
                      paste0(comma(S1811_C02_032_estimate * 
                                     (S1811_C02_033_estimate +
                                        S1811_C02_034_estimate),
                                   accuracy = 1),
                             "<br>(", comma((S1811_C02_033_estimate +
                                            S1811_C02_034_estimate),
                                         accuracy = 0.1), "%)"),
                    "Transit" = 
                      paste0(comma(S1811_C02_032_estimate * 
                                     (S1811_C02_035_estimate),
                                   accuracy = 1),
                             "<br>(", comma(S1811_C02_035_estimate,
                                         accuracy = 0.1), "%)"),
                    
                    "Walk or<br>Bike" = 
                      paste0(comma(S1811_C02_032_estimate * 
                                     (S1811_C02_036_estimate +
                                        S1811_C02_037_estimate),
                                   accuracy = 1),
                             "<br>(", comma((S1811_C02_036_estimate +
                                            S1811_C02_037_estimate),
                                         accuracy = 0.1), "%)"),
                    "Work from<br>Home" = 
                      paste0(comma(S1811_C02_032_estimate * 
                                     (S1811_C02_038_estimate),
                                   accuracy = 1),
                             "<br>(", comma((S1811_C02_038_estimate),
                                         accuracy = 0.1), "%)"),
                    "<b>Total" = 
                      paste0(comma(S1811_C02_032_estimate, 
                                   accuracy = 1),
                             "</b>")) %>% 
          pivot_longer(everything(),
                       names_to = "Commute",
                       values_to = "PWD (%)"),
        caption = "Commute, Workers 16+",
        escape = FALSE,
        align = c("l", "r") #,
        # table.attr = "style='width:100%;'"
    ) %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                    position = "left"),
    
    # Work/Economic
    kbl(x = metro_snapshot_place() %>%
          transmute("Employed" = 
                      paste0(comma(S1811_C02_004_estimate, accuracy = 1),
                             "<br>(", S1811_C02_002_estimate, "%)"),
                    "Not in<br>Labor Force" = 
                      paste0(comma((S1811_C02_001_estimate - S1811_C02_004_estimate), accuracy = 1), 
                             "<br>(", S1811_C02_003_estimate, "%)"),
                    "<b>Total" = 
                      paste0(comma(S1811_C02_001_estimate, accuracy = 1),
                             "</b>")) %>%
          pivot_longer(everything(),
                       names_to = "Employment",
                       values_to = "PWD (%)"),
        caption = "Employment, 16+",
        escape = FALSE,
        align = c("l", "r") #,
        # table.attr = "style='width:100%;'"
    ) %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                    position = "left")
    
  )) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                  position = "left")
  
  # UI Output
  HTML(paste(metro_snap_overview_text, metro_snap_tables, sep = "<br>"))
  
})

```

### People With Disabilities Map

```{r metro snapshot overview map, fig.alt="Map of people with disabilities by census tract in the selected city", context="server"}

# Palette
pal_metro_snapshot <- reactive ({
  
  colorQuantile(palette = input$access_map_palette,
                domain = pull(metro_snapshot_tract(), S1810_C02_001_estimate),
                n = 4)
  
})

# Tract map
output$snapshotmap <- renderLeaflet({
  
  left_join(metro_snapshot_tract_sf(),
            metro_snapshot_tract() %>% select(GEOID, S1810_C02_001_estimate),
            by = "GEOID") %>%
    leaflet() %>%
    clearShapes() %>%
    addProviderTiles(providers$Esri, group = "Esri") %>%
    addProviderTiles(providers$CartoDB.Positron, group = "CartoDB") %>%
    addResetMapButton() %>%
    addPolygons(stroke = TRUE, color = "#444444", weight = 1, smoothFactor = 0,
                fillColor = ~pal_metro_snapshot()(S1810_C02_001_estimate),
                fillOpacity = 0.5,
                layerId = ~GEOID) %>%
    addLegend(position = "topright", pal = pal_metro_snapshot(),
              values = ~S1810_C02_001_estimate,
              labFormat =  function(type, cuts, p) {
                n = length(cuts)
                paste0(as.numeric(cuts)[-n], " &ndash; ", as.numeric(cuts)[-1])
              },
              title = "PWD") %>% 
    addLayersControl(position = "bottomright",
                     baseGroups = c("Esri", "CartoDB"),
                     options = layersControlOptions(collapsed = FALSE)) %>%
    addSearchOSM(options = searchOptions(autoCollapse = FALSE, minLength = 3,
                                         position = "topleft", zoom = 15,
                                         autoResize = FALSE,
                                         hideMarkerOnCollapse = TRUE))
  
})

# Click event for the map
click_snapshotmap <- eventReactive(input$snapshotmap_shape_click, {
  
  x <- input$snapshotmap_shape_click
  y <- x$id
  
  return(y)
  
})

# Add the clicked state to the map, and remove when a new one is clicked
observe({
  
  req(click_snapshotmap())
  
  snapshotmap <- leafletProxy("snapshotmap") %>%
    removeShape("highlight_tract") %>%
    addPolygons(data = metro_snapshot_tract_sf()[metro_snapshot_tract_sf()$GEOID == click_snapshotmap(), ], 
                fill = FALSE, weight = 3,
                color = "#000000", opacity = 1, layerId = "highlight_tract")
  
})

leafletOutput("snapshotmap") 

```

## Row

### City in Context

```{r metro snapshot plots, fig.alt=c("Scatterplot of the percent of people with disabilities (y-axis) versus total population (x-axis)", "Scatterplot of the percent of people with disabilities with a bachelor's degree or higher (y-axis) versus people with disabilities population (x-axis)", "Scatterplot of people with disabilities employment rate (y-axis) versus people with disabilities population (x-axis)"), context="server"}

# ===============
# Demographics
# ===============

# Definition
output$metro_snapshot_demo_plot <- renderPlotly({
  
  # Plot
  gg <- metro_snapshot_place_full %>%
    mutate("NAME" = str_replace_all(
      NAME, 
      pattern = " (city|village|municipality|town), ",
      replacement = ", ")) %>% 
    select(GEOID,
           NAME, 
           "pwd" = S1810_C02_001_estimate,
           "total_population" = S1810_C01_001_estimate,
           "pwd_pct" = S1810_C03_001_estimate) %>%
    ggplot(aes(text = paste0("City: ", NAME, 
                             "<br>PWD: ", scales::comma(pwd,
                                                        accuracy = 1), 
                             " (", pwd_pct, "%)",
                             "<br>Total Pop.: ", 
                             scales::comma(total_population,
                                           accuracy = 1)))) +
    geom_point(stat = "identity",
               alpha = 0.8, position = "jitter",
               aes(x = total_population, y = pwd_pct)) +
    gghighlight(GEOID == input$metro_snapshot) +
    labs(x = "Total Population", 
         y = "PWD (%)",
         title = "People with Disabilities (%) vs. Total Population") +
    scale_x_log10(labels = scales::comma) +
    scale_y_continuous(labels = function(x) paste0(x, "%")) +
    ggplot_fill_selected() +
    ggplot_theme_selected() +
    theme(legend.position = "top")
  
  # Interactive plotly settings
  plotly::ggplotly(gg, tooltip = "text") %>% 
    plotly::layout(
      height = 280,
      margin = list(l = 25, t = 25, b = 90),
      xaxis = list(title = list(text = "Total Population",
                                standoff = 5,
                                font = list(size = 14)),
                   tickfont = list(size = 12)),
      yaxis = list(title = list(text = "PWD (%)",
                                standoff = 5,
                                font = list(size = 14)),
                   tickfont = list(size = 12)),
      title = list(text = "People with Disabilities (%) vs. Total Population",
                   font = list(size = 16),
                   yref = "paper",
                   y = 1,
                   yanchor = "bottom"),
      font = list(size = 10)
    )
  
})

# ===============
# Community Participation
# ===============

output$metro_snapshot_cp_plot <- renderPlotly({
  
  # Plot
  gg <- metro_snapshot_place_full %>%
    mutate("NAME" = str_replace_all(
      NAME, 
      pattern = " (city|village|municipality|town), ",
      replacement = ", ")) %>%  
    select(GEOID,
           NAME,
           "pwd_25_over" = S1811_C02_039_estimate,
           "pwd_bachelors" = S1811_C02_043_estimate) %>% 
    ggplot(aes(text = paste0("City: ", NAME, 
                             "<br>PWD Bachelor's or Higher: ", pwd_bachelors, "%",
                             "<br>PWD 25+: ", scales::comma(pwd_25_over,
                                                            accuracy = 1)))) +
    geom_point(stat = "identity",
               alpha = 0.8, position = "jitter",
               aes(x = pwd_25_over, y = pwd_bachelors)) +
    gghighlight(GEOID == input$metro_snapshot) +
    labs(x = "PWD, 25 or Older", 
         y = "Bachelor's Degree or Higher (%)",
         title = "Bachelor's Degree or Higher (%) vs. PWD Population 25 or Older") +
    scale_x_log10(labels = scales::comma) +
    scale_y_continuous(labels = function(x) paste0(x, "%")) +
    ggplot_fill_selected() +
    ggplot_theme_selected() +
    theme(legend.position = "top")
  
  # Interactive plotly settings
  plotly::ggplotly(gg, tooltip = "text") %>% 
        plotly::layout(
      height = 280,
      margin = list(l = 25, t = 25, b = 90),
      xaxis = list(title = list(text = "PWD, 25 or Older",
                                standoff = 5,
                                font = list(size = 14)),
                   tickfont = list(size = 12)),
      yaxis = list(title = list(text = "Bachelor's Degree or Higher (%)",
                                standoff = 5,
                                font = list(size = 14)),
                   tickfont = list(size = 12)),
      title = list(text = "Bachelor's Degree or Higher (%) vs. PWD Population 25 or Older",
                   font = list(size = 16),
                   yref = "paper",
                   y = 1,
                   yanchor = "bottom"),
      font = list(size = 10)
    )
  
})

# ===============
# Work/Economic
# ===============

# Definition
output$metro_snapshot_we_plot <- renderPlotly({
  
  # Plot
  gg <- metro_snapshot_place_full %>%
    mutate("NAME" = str_replace_all(
      NAME, 
      pattern = " (city|village|municipality|town), ",
      replacement = ", ")) %>% 
    select(GEOID,
           NAME,
           "pwd_employed" = S1811_C02_004_estimate,
           "pwd" = S1811_C02_001_estimate,
           "pwd_employed_pct" = S1811_C02_002_estimate) %>% 
    ggplot(aes(text = paste0("City: ", NAME, 
                             "<br>PWD Employed: ", 
                             scales::comma(pwd_employed,
                                           accuracy = 1), 
                             " (", pwd_employed_pct, "%)",
                             "<br>PWD ", scales::comma(pwd,
                                                       accuracy = 1)))) +
    geom_point(stat = "identity",
               alpha = 0.8, position = "jitter",
               aes(x = pwd, y = pwd_employed_pct)) +
    gghighlight(GEOID == input$metro_snapshot) +
    labs(x = "People with Disabilities", 
         y = "PWD Employment Rate (%)",
         title = "PWD Employment Rate (%) vs. PWD Population") +
    scale_x_log10(labels = scales::comma) +
    scale_y_continuous(labels = function(x) paste0(x, "%")) +
    ggplot_fill_selected() +
    ggplot_theme_selected() +
    theme(legend.position = "top")
  
  # Interactive plotly settings
  plotly::ggplotly(gg, tooltip = "text") %>% 
    plotly::layout(
      height = 280,
      margin = list(l = 25, t = 25, b = 90),
      xaxis = list(title = list(text = "PWD Population",
                                standoff = 5,
                                font = list(size = 14)),
                   tickfont = list(size = 12)),
      yaxis = list(title = list(text = "PWD Employment Rate (%)",
                                standoff = 5,
                                font = list(size = 14)),
                   tickfont = list(size = 12)),
      title = list(text = "PWD Employment Rate (%) vs. PWD Population",
                   font = list(size = 16),
                   yref = "paper",
                   y = 1,
                   yanchor = "bottom"),
      font = list(size = 10)
    )
  
})

# Tab panel output
tabsetPanel(type = "tabs",
            tabPanel("Demographics",
                     plotlyOutput("metro_snapshot_demo_plot")),
            tabPanel("Community Participation",
                     plotlyOutput("metro_snapshot_cp_plot")),
            tabPanel("Work/Economic",
                     plotlyOutput("metro_snapshot_we_plot")))

```

### Characteristics of Selected Tract (Click on Map to Show Table) {.table-wrapper}

```{r, metro snapshot tract table}

# Reconfigure tract data for table
metro_snapshot_table_data <- reactive({
  
  # Select tract
  temp <- metro_snapshot_tract()[metro_snapshot_tract()$GEOID == click_snapshotmap(), ] 
  
  # Static check
  # Census Tract 59.01, Montgomery County, Alabama
  # temp_mongo_conn <- fun_mongo_connect(host_name = "host_dev",
  #                                      collection_name = "acs_tract_S1810",
  #                                      database_name = "ADA-PARC")
  # temp <- temp_mongo_conn$find(
  #   query = sprintf('{ "GEOID" : { "$in" : ["01101005901" ] } }'))

  # Value and percent (Remove White and Hispanic, reorder Race topic)
  temp_values <- temp %>% 
    select(GEOID:NAME, matches("_C02_")) %>%
    # Values
    pivot_longer(cols = -c(GEOID:NAME),
                 names_to = c("variable", ".value"),
                 names_pattern = "(.*)_(.*)") %>% 
    # Percent
    mutate("pct" = format(round((estimate / max(estimate)) * 100,
                                digits = 1),
                          nsmall = 1)) %>% 
    mutate("pct" = replace_na(pct, 0)) %>% 
    # Variable order
    filter(!variable %in% c("S1810_C02_004")) %>% 
    mutate("variable" = fct_relevel(
      variable,
      c("S1810_C02_001", 
        # Gender
        "S1810_C02_002", "S1810_C02_003",
        # Race/Ethnicity
        "S1810_C02_011", "S1810_C02_005", "S1810_C02_012",
        "S1810_C02_007", "S1810_C02_006", "S1810_C02_008",
        "S1810_C02_009", "S1810_C02_010",
        # Age
        "S1810_C02_013", "S1810_C02_014", "S1810_C02_015",
        "S1810_C02_016", "S1810_C02_017", "S1810_C02_018"))) %>% 
    arrange(variable)

  # Output
  temp_values %>%
    left_join(.,
              dict_vars %>% 
                select("category" = var_topic,
                       "label" = var_pretty,
                       "variable" = var_database),
              by = "variable") %>%
    # Label
    mutate("label" = str_remove_all(label, 
                                    "Total Persons with Disabilities, ")) %>%
    mutate("label" = case_when(variable == "S1810_C02_001" ~
                                 "People with Disabilities",
                               variable == "S1810_C02_011" ~
                                 "White alone",
                               variable == "S1810_C02_012" ~
                                 "Hispanic or Latino",
                               TRUE ~ label)) %>%
    mutate("category" = str_to_title(category)) %>% 
    select(GEOID, NAME, category, variable, label,
           estimate, moe, pct) 
  
})

# Table
renderUI({ 
  
  # Req
  req(nrow(metro_snapshot_table_data()) > 0)
  
  HTML(
  
    kbl(x = metro_snapshot_table_data() %>%
          mutate("output_est" = paste0(comma(estimate,
                                             accuracy = 1), 
                                       " (", pct, "%)"),
                 "output_moe" = paste0("(±", 
                                       comma(moe,
                                             accuracy = 1),
                                       ")")) %>% 
          mutate(across(everything(), 
                        ~cell_spec(., "html",
                                   color = ifelse(moe >= estimate, 
                                                  "red", "black")))) %>%
          select("Variable" = label, "Est" = output_est,  "MOE" = output_moe),
        caption = metro_snapshot_table_data() %>% head(1) %>% pull(NAME),
        escape = FALSE,
        table.attr = "style='width:100%;'") %>% 
      pack_rows(index = table(
        fct_inorder(metro_snapshot_table_data()$category))) %>% 
      kable_styling(bootstrap_options = c("striped", "hover", 
                                          "condensed"),
                    full_width = TRUE)
  
) })

```

<!-- Comparison {data-navmenu="By Metro"} -->

<!-- ====================================================================== -->

<!-- Sidebar {.sidebar} -->

<!-- ----------------------------------------------------------------------- -->

<!-- <br> -->

<!-- ```{r } -->

<!-- # Same for the other city-level data we have available (i.e. community_participation and work_economic. recommend flopping the naming convention here to metro_demo_data to keep things organized, i should probably do that for national as well) -->

<!-- ``` -->

<!-- ```{r } -->

<!-- # Define inputs -->

<!-- # Metro -->

<!-- selectizeInput(inputId = "compare",  -->

<!--                label = "Select Metro Areas to Compare",  -->

<!--                choices = metro_snapshot_tract() %>% select(metro_state), -->

<!--                multiple = TRUE, -->

<!--                options = list( -->

<!--                  maxItems = 3, -->

<!--                  placeholder = "select up to 3 cities" -->

<!--                ) -->

<!-- ) -->

<!-- ### I want to model something similar to the AARP website -->

<!-- ### So these three inputs would feed into the DT and then we could do a transposed table of -->

<!-- ### some subset of relevant fields for the user based on a selection -->

<!-- ``` -->

<!-- Row -->

<!-- ----------------------------------------------------------------------- -->

<!-- ### Table {.download-DT} -->

<!-- ```{r } -->

<!-- DT::renderDataTable({ -->

<!--   if(is.null(input$compare)){ -->

<!--     DT::datatable( -->

<!--       metro_demo_data %>%  -->

<!--         rename("City" = metro_state), -->

<!--       options(lengthMenu = list(c(5, 10, 20, -1), c("5", "10", "20", "All"))) -->

<!--     ) -->

<!--   }else{ -->

<!--     DT::datatable( -->

<!--       metro_demo_data %>%  -->

<!--         filter(metro_state %in% input$compare) %>%  -->

<!--         select("City" = metro_state, everything()) %>% -->

<!--         pivot_longer( -->

<!--           cols = -"City", -->

<!--           names_to = "Variable" -->

<!--         ) %>% -->

<!--         pivot_wider( -->

<!--           id_cols = Variable, -->

<!--           names_from = City -->

<!--         ) %>% -->

<!--         select(" " = Variable, everything()), -->

<!--       options (pageLength = 50) -->

<!--     ) -->

<!--   } -->

<!-- }) -->

<!-- ``` -->

<!-- Explore {data-navmenu="By Metro"} -->

<!-- ====================================================================== -->

<!-- Sidebar {.sidebar} -->

<!-- ----------------------------------------------------------------------- -->

<!-- <br> -->

<!-- ```{r metro explore sidebar} -->

<!-- # Define inputs -->

<!-- # Metro -->

<!-- selectizeInput(inputId = "metro_explore_select",  -->

<!--                label = "Select Metro Areas to explore",  -->

<!--                choices = metro_demo_data %>% select(metro_state),  -->

<!--                multiple = TRUE,  -->

<!--                options = list("plugins" = list("remove_button"),  -->

<!--                               "create" = TRUE, -->

<!--                               "persist" = FALSE)) -->

<!-- # Variable of interest -->

<!-- selectizeInput(inputId = "var_explore_select",  -->

<!--                label = "Select a demographic variable",  -->

<!--                choices = names(metro_demo_data %>% select(pwd:percent_pwd_female)),  -->

<!--                selected = names(metro_demo_data %>% select(pwd)), -->

<!--                multiple = TRUE,  -->

<!--                options = list("plugins" = list("remove_button"),  -->

<!--                               "create" = TRUE, -->

<!--                               "persist" = FALSE)) -->

<!-- ``` -->

<!-- Row -->

<!-- ----------------------------------------------------------------------- -->

<!-- ### Table {.download-DT} -->

<!-- ```{r metro explore table} -->

<!-- DT::renderDataTable({ -->

<!--   if(is.null(input$metro_explore_select)){ -->

<!--     DT::datatable( -->

<!--       metro_demo_data %>%  -->

<!--         rename("City" = metro_state), -->

<!--       options(list(scrollX = "200px", -->

<!--                    pageLength = 5, -->

<!--                    lengthMenu = list(c(5, 10, 20, -1), c("5", "10", "20", "All")))) -->

<!--     ) -->

<!--   }else{ -->

<!--     DT::datatable( -->

<!--       metro_demo_data %>%  -->

<!--         filter(metro_state %in% input$metro_explore_select) %>%  -->

<!--         select("City" = metro_state, input$var_explore_select), -->

<!--       options(list(scrollX = "200px",  -->

<!--                    pageLength = 5, -->

<!--                    lengthMenu = list(c(5, 10, 20, -1), c("5", "10", "20", "All")))) -->

<!--     ) -->

<!--   } -->

<!-- }) -->

<!-- ``` -->

<!-- Row -->

<!-- ----------------------------------------------------------------------- -->

<!-- ### Selected Variables by Metro -->

<!-- ```{r metro overview chart} -->

<!-- output$metro_explore_plot <- renderPlotly({ -->

<!--   # Require input action and non-null variable before plotting chart -->

<!--   req(input$metro_explore_select) -->

<!--   req(!is.null(input$var_explore_select)) -->

<!--   # Plot -->

<!--   plotly::ggplotly( -->

<!--     metro_demo_data %>% -->

<!--       filter(metro_state %in% input$metro_explore_select) %>% -->

<!--       select(metro_state, input$var_explore_select) %>% -->

<!--       pivot_longer(cols = -metro_state, names_to = "variable", values_to = "value") %>% -->

<!--       mutate(variable = str_replace_all(variable, "_", " "), -->

<!--              value = as.numeric(value)) %>% -->

<!--       ggplot(aes(x = variable, y = value, fill = metro_state)) + -->

<!--       geom_bar(stat = "identity", width = 0.8, -->

<!--                position = position_dodge2(width = 0.6, preserve = "single")) + -->

<!--       labs(x = "Variable", y = "Value") + -->

<!--       scale_y_comma() + -->

<!--       coord_flip() + -->

<!--       ggplot_fill_selected() + -->

<!--       ggplot_theme_selected() + -->

<!--       theme(legend.position = "top") -->

<!--   ) -->

<!-- }) -->

<!-- plotlyOutput("metro_explore_plot") -->

<!-- ``` -->

# Data {data-navmenu="Download" data-icon="fa-database"}

## Sidebar {.sidebar}

<br>

```{r, data download sidebar}

# ====================
# Filters
# ====================

# Define inputs
radioButtons(inputId = "data_download_national",
             label = "Select an Area of Interest",
             choices = c("Demographics" = "demographics",
                         "Community Living" = "community_living", 
                         "Community Participation" = "community_participation", 
                         "Work/Economic" = "work_economic"),
             selected = NULL)

# Restrict statistic breakdown based on type
data_download_national_selected <- reactive({
  
  eval(sym(input$data_download_national))
  
})

```

## Row

### Selected Data for Download {.download-DT}

```{r, data download table}

# Selected data for download
output$data_download_table <- DT::renderDataTable({
  
  DT::datatable(data_download_national_selected(),
                fillContainer = TRUE,
                extensions = "Buttons",
                options = list(dom = "Bfrtip",
                               buttons = c("copy", "csv", "excel", "pdf", "print"),
                               bPaginate = FALSE,
                               scrollX = "200px",
                               scrollY = "800px",
                               pageLength = dim(data_download_national_selected())[1]))
  
})

DT::dataTableOutput("data_download_table", width = 50)

```

# Fact Sheets {data-navmenu="Download" data-icon="fa-file-alt"}

## Sidebar {.sidebar}

```{r, fact sheet download sidebar}

# ====================
# Lookups for filters
# ====================

# Demographics
demographics_lu <- names(national_demographics) %>% 
  as_tibble_col(column_name = "column_name") %>% 
  mutate(column_type =
           case_when(str_detect(string = column_name,
                                pattern = "percent") ~
                       "percent",
                     TRUE ~ "value"),
         filter_temp = 
           case_when(column_name %in%
                       c("pwd",
                         "percent_of_total_population_with_a_disability") ~
                       "general __ General",
                     column_name %in%
                       c("pwd_18_64_years",
                         "pwd_65_years") ~
                       "age __ Age",
                     TRUE ~ NA_character_)) %>% 
  filter(!is.na(filter_temp)) %>% 
  separate(col = "filter_temp", 
           into = c("filter_value", "filter_label"),
           sep = " __ ")

# Community Living
community_living_lu <- names(national_living) %>% 
  as_tibble_col(column_name = "column_name") %>% 
  mutate(column_type =
           case_when(str_detect(string = column_name,
                                pattern = "percent") ~
                       "percent",
                     TRUE ~ "value"),
         filter_temp = 
           case_when(column_name %in%
                       c("pwd_in_institutionalized_group_quarters",
                         "percent_pwd_institution") ~
                       "institution_pop __ PWD Living in Institutional Residence",
                     column_name %in%
                       c("pwd_in_home",
                         "percent_pwd_home") ~
                       "home_pop __ PWD Living in Home Residence",
                     column_name %in%
                       c("pwd_in_non_institutional_group_quarters",
                         "percent_pwd_other_group_quarters") ~
                       "othergq_pop __ PWD Living in Other Group Quarters Residence",
                     column_name %in%
                       c("total_population_in_nursing_18_64",
                         "percent_of_pwd_18_64_in_nursing") ~
                       "nursing_working_pop __ PWD of Working Age, Living in Nursing Home",
                     TRUE ~ NA_character_)) %>% 
  filter(!is.na(filter_temp)) %>% 
  separate(col = "filter_temp", 
           into = c("filter_value", "filter_label"),
           sep = " __ ")

# ====================
# Filters
# ====================

# Define inputs
radioButtons(inputId = "fact_sheet_national",
             label = "Select an Area of Interest",
             choices = c("Demographics", "Community Living", 
                         "Community Participation", "Work/Economic"))

# Restrict statistic breakdown based on type
fact_sheet_national_selected <- reactive({
  
  if (input$fact_sheet_national == "Demographics"){
    demographics_lu
  } else if (input$fact_sheet_national == "Community Living"){
    community_living_lu
    # } else if (input$fact_sheet_national == "Community Living"){
    #   community_participation_lu
  } else {
    NA
  }
  
})

# Statistics dropdown to given area
renderUI({ 
  
  selectInput(inputId = "fact_sheet_stat", 
              label = "Select a Statistic", 
              choices = unique(fact_sheet_national_selected()$filter_label))
  
})

# Restrict statistic breakdown based on type
stat_base <- reactive({
  
  if (input$fact_sheet_national == "Demographics"){
    national_demographics
  } else if (input$fact_sheet_national == "Community Living"){
    national_living
    # } else if (input$fact_sheet_national == "Community Participation"){
    #   national_participation
  } else {
    NA
  }
  
})

# Select columns based on input
stat_subset <- reactive({
  
  stat_base() %>% 
    select(state:abbrev,
           all_of(fact_sheet_national_selected() %>% 
                    filter(filter_label == input$fact_sheet_stat) %>% 
                    pull(column_names)))
  
})


```

# Accessibility

## Row

###  {.long-row}

```{r}

# Map palette
selectInput(inputId = "access_map_palette",
            label = h5("Select a color palette for maps:"),
            choices = list("Yellow-Orange-Brown" = "YlOrBr", 
                           "Yellow-Orange-Red" = "YlOrRd", 
                           "Green-Blue" = "GnBu"),
            selected = "Yellow-Orange-Brown")


# GGplot themes and colors
access_ggplot_themes <- list(
  "The Economist" = list(theme_economist(), scale_fill_economist(), scale_color_economist()),
  "Five Thirty Eight" = list(theme_fivethirtyeight(), scale_fill_economist(), scale_color_fivethirtyeight()),
  "Highcharts" = list(theme_hc(), scale_fill_hc(), scale_color_hc()),
  "Ipsum" = list(theme_ipsum(), scale_fill_colorblind(), scale_color_colorblind()),
  "Light" = list(theme_light(), scale_fill_colorblind(), scale_color_colorblind()),
  "Minimal" = list(theme_minimal(),scale_fill_ordinal(), scale_color_ordinal()),
  "Stata" = list(theme_stata(), scale_fill_stata(), scale_color_stata()))

selectInput(inputId = "access_ggplot_theme", 
            label = h5("Select a theme for plots:"), 
            choices = names(access_ggplot_themes),
            selected = "Ipsum")

ggplot_theme_selected <- reactive({ access_ggplot_themes[[input$access_ggplot_theme]][1] })
ggplot_fill_selected <- reactive({ access_ggplot_themes[[input$access_ggplot_theme]][2] }) 
ggplot_color_selected <- reactive({ access_ggplot_themes[[input$access_ggplot_theme]][3] }) 

```

<!-- Custom Javascript  -->

```{=html}
<script>
$("body").on("shown.bs.tab", "a[data-toggle='tab']", function(e) {
Shiny.setInputValue("active_tab", $(e.target).parent().index());
})
</script>
```
<!-- CSS for dashboard  -->

```{=html}
<style  type="text/css">

/* #################### */
/* Fonts */
/* #################### */

/* Headers */
h2,h3,h4,h5 { 
font-weight: bold;
}

/* #################### */
/* Coloring */
/* #################### */

/* Leaflet border */
.leaflet .legend i{
border-left:1px solid #000000;
border-right:1px solid #000000;
border-top:1px solid #000000;
border-bottom:1px solid #000000;
}

/* Leaflet background */
.leaflet-container {
background: #696969;
}

/* Section dividers */
.section-divider { 
background-color: #CCCCCC;
color: #000000;
}

/* Colors for map palette dropdown */
#access_map_palette ~ .selectize-control .option[data-value=YlOrBr]{ 
background-image: linear-gradient(to right, white, #ffffd4, #fed98e, #fe9929, #cc4c02) !important;
background-size: auto !important;
}

#access_map_palette ~ .selectize-control .option[data-value=YlOrRd]{ 
background-image: linear-gradient(to right, white , #ffffb2, #fecc5c, #fd8d3c, #e31a1c) !important;
background-size: auto !important;
}

#access_map_palette ~ .selectize-control .option[data-value=GnBu]{ 
background-image: linear-gradient(to right, white , #f0f9e8, #bae4bc, #7bccc4, #2b8cbe) !important;
background-size: auto !important;
}



/* #################### */
/* Containers */
/* #################### */

/* Set max length for dropdowns */
.selectize-dropdown-content {
padding: 10px;
}

/* Allow dropdowns to be visible for short containers */
#access_ggplot_theme+ div>.selectize-dropdown, #access_map_palette+ div>.selectize-dropdown {
position: static;
}

/* Have dropdowns display on top of Leaflet */
.selectize-dropdown {
z-index: 10000;
overflow-y: auto;
}

/* Scroll overflow for tables */
.table-wrapper {
overflow-x: scroll;
overflow-y: scroll;
}

/* Scroll overflow for Download */
.download-DT {
overflow-x: scroll;
overflow-y: scroll;
}

</style>
```
