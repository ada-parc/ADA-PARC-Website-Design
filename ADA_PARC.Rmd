---
title: "ADA-PARC"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: cosmo
    includes:
      in_header: www/cssloaders.html
    css: www/styles.css
runtime: shiny
resource_files:
- www/participant_logos.png
- scripts/functions.R
- data/ADA-Website_tables_national.Rda
- data/ADA-Website_tables_city.Rda
- data/ADA-Website_tracts.Rda
- data/dict_vars.csv
---

```{r setup, include=FALSE}

### ----- Libraries -----

# Install from devtools non-CRAN packages as needed
# devtools::install_github("daattali/shinycssloaders", ref = "rmarkdown") # rmarkdown branch must be installed and cssloaders_in_header.html must exist
# devtools::install_github("UrbanInstitute/urbnmapr")

# Packages
library(reactlog)
library(tidyverse)
library(patchwork)
library(kableExtra)
library(tigris); library(sf)
library(urbnmapr)
library(leaflet); library(leaflet.extras)
library(htmltools)
library(shiny); library(shinycssloaders)
library(shinyWidgets); library(flexdashboard)
library(colourpicker)
library(scales)
library(tableHTML)
library(hrbrthemes); library(ggthemes)
library(extrafont)

options(scipen = 999999,
        tigris_use_cache = TRUE,
        shiny.reactlog = TRUE)
knitr::opts_chunk$set(fig.cap = TRUE)


### ----- Data import and clean -----


# Load in environment variables from "Data-Update" process
# National tables
# load(here::here("data", "ADA-Website_tables.Rda"))
load(here::here("data", "ADA-Website_tables_national.Rda"))
# City tables
load(here::here("data", "ADA-Website_tables_city.Rda"))
# City tracts sf
load(here::here("data", "ADA-Website_tracts.Rda"))

# Read in variable dictionary manually
dict_vars <- read_csv(here::here("data", "dict_vars.csv"))
# dict_vars_old <- read_csv(here::here("data", "dict_vars_2022-08-22.csv"))

# Standardize city GEOID, csv vs txt can mess up structure
dict_location_crosswalk <- dict_location_crosswalk %>%
  mutate("place_GEOID" = str_pad(as.character(place_GEOID),
                                 width = 7, side = "left",
                                 pad = "0"),
         "tract_GEOID" = str_pad(as.character(tract_GEOID),
                                 width = 11, side = "left",
                                 pad = "0"),
         "city" = str_remove(metro_state, ", [A-Z]{2}$"),
         "state" = str_extract(metro_state, "[A-Z]{2}$"))

# Export locally as needed
# # Tables
# save(city_place_full, community_living, community_participation,
#      demographics, dict_location_crosswalk, work_economic,
#      tracts_data,
#      file = here::here("data", "ADA-Website_tables_copy.Rda"))
# 
# Tables for scorecard work
# openxlsx::write.xlsx(
#   list("National - Demo" = demographics,
#        "National - Comm Part" = community_participation,
#        "National - Comm Living" = community_living,
#        "National - Economic" = work_economic,
#        "City" = city_place_full,
#        "Tract" = tracts_data,
#        "Dict - Geo Crosswalk" = dict_location_crosswalk,
#        "Dict - Variables" = dict_vars),
#   here::here("data",
#              "ADA-PARC_Website_Data.xlsx"))
#
# # Tracts spatial data
# save(tracts_sf,
#      file = here::here("data", "ADA-Website_tracts_copy.Rda"))


### ----- Functions import -----


# Load API keys and database connection information
source(here::here("scripts", "functions.R"), local = TRUE)

```

# Home

## Sidebar {.sidebar}

<br>

#### How to Navigate<br>this Website
<br>
Use the **National Data** tab to examine the status of people with disabilities at the national and state level.

Use the **City Data** tab to investigate people with disabilities statistics at the municipal level.

Use the **Accessibility** tab to set color palettes for the visualizations in this dashboard.

<br>

**Questions?** <br>
[Contact Joy Hammel (email)](mailto:hammel@uic.edu) <br>
Director of Graduate Studies <br>
UIC College of Applied Health Sciences

Application authors: <br>
Ethan Jantz, Sean Connelly, and Jane Huber <br>
[UIC Voorhees Center](https://voorheescenter.uic.edu/)

<div role="main">

## Row

### 

<br>

Welcome to the ADA-PARC website. The ADA-PARC is a collaborative research project of ten Americans with Disabilities Act (ADA) Regional Centers.

<br>

#### Purpose of ADA-PARC

The ADA-PARC research has four purposes:

1.  **To look at participation disparities** experienced by people with disabilities post ADA & Olmstead
2.  **To identify & examine key environmental factors** contributing to these disparities
3.  **To benchmark participation disparities and highlight promising practices** at state & city levels
4.  **To action-plan strategies for dissemination and utilization of findings** to be used by ADA Centers and others in community capacity building & systems change initiatives

<br>

#### The Work of the ADA-PARC

The ADA-PARC has research teams focused on Community Living, Community Participation & Work/Economic Participation measures and uses Regional Steering Committees in each of the ten participating regions to gather, review, and choose appropriate data to achieve the project's purposes. The data are mainly from national data sources that have enough statistical power to be relevant on the local level.

The intent of this effort is to use this information to inform:

1.  ADA Center technical assistance and resource dissemination, and
2.  Community level stakeholders to increase participation opportunities in their communities.

<br>

#### Who is the ADA-PARC

The ten participating ADA-Regional Centers in the ADA-PARC are:

-   Region 1 New England ADA Center
-   Region 2 Northeast ADA Center
-   Region 3 Mid-Atlantic ADA Center
-   Region 4 Southeast ADA Center
-   Region 5 Great Lakes ADA Center
-   Region 6 Southwest ADA Center
-   Region 7 Great Plains ADA Center
-   Region 8 Rocky Mountain ADA Center
-   Region 9 Pacific ADA Center
-   Region 10 Northwest ADA Center

Other institutions collaborating in the ADA-PARC are:

-   The ADA Knowledge Translation Center
-   The Center on Disability at the Public Health Institute
-   TIRR Memorial Hermann
-   Syracuse University
-   The University of Illinois at Chicago
-   The University of Northern Colorado

<br>

<img src="./www/participant_logos.png" alt="The ten participating ADA-Regional Centers" width="75%">

<br>

#### About this Website

The ADA-PARC website is a collection of public data sets that can help shed light on the status of people with disabilities in local communities. The data includes national, state, county, and city data. In addition to Demographic data describing the population, the three main areas of data to illuminate the status of disability in an area are: Community Living, Community Participation and Work & Economics. Each of the three areas presents data in map form as well as in tabular form. A summary of what is important about the data is presented on each page. The data source is described along with the calculation to arrive at the values used in the tables and maps. Data is first presented by state, and then if available, at county and city level.

The ADA Participation Action Consortium is funded by the National Institute on Disability, Independent Living, and Rehabilitation Research (NIDILRR) (90DP0026 and 90DPAD0001). NIDILRR is a Center within the Administration for Community Living (ACL), Department of Health and Human Services (HHS). The contents of this website do not necessarily represent the policy of NIDILRR, ACL, HHS, and you should not assume endorsement by the Federal Government.

</div>

<div role="main">

# National Data

<div role="region" aria-labelledby="sidebar">

## Sidebar {.sidebar}

<br>

To explore the data first select a category and then a topic. You can navigate the boxes below using the mouse or keyboard. For keyboard users, once the box is highlighted you can press backspace and begin typing the selection into the box.

```{r national-sidebar, context="server", message=FALSE, warning=FALSE, fig.alt = "A sidebar containing two drop down menus. One selects a category, and the other selects a topic within that category. These other elements of this page will change based on the selected category and topic."}


### ----- Category selector ------

# National category selection widget
national_category_choices <- c(
  "Demographics" = "is_demographics", 
  "Community Participation" = "is_community_participation", 
  "Community Living" = "is_community_living", 
  "Work/Economic" = "is_work_economic"
)

# Select the data frame to use
selectInput(inputId = "national_category_selector", 
            label = "Select a category", 
            choices = names(national_category_choices),
            selected = "is_demographics",
            multiple = FALSE)

# Selected category for function inputs
# Output looks like "is_demographics"
national_category_selected <- reactive({ 
  
  getElement(national_category_choices, input$national_category_selector)
  
})


### ----- National data  ------


# Select dataframe for national data tab
national_data <- reactive({
  
  eval(sym(str_remove(national_category_selected(), "^is_")))
  
})


### ----- Variable selector  ------


# National variable selection choices, based on category
national_variable_choices <- reactive({
  
  tibble::deframe(
    dict_vars %>%
      filter(!!sym(national_category_selected()) == TRUE,
             var_readable %in% (
               national_data() %>%
                 select(-c(GEOID, NAME, ABBR)) %>%
                 names()
             ),
             !is.na(national_dropdown_label)) %>%
      select(national_dropdown_label, var_readable)
  )
  
})

# National variable selection widget, default options
selectInput(inputId = "national_variable_selector",
            label = "Select a topic",
            choices = tibble::deframe(c("Population", "pop_total")),
            selected = "pop_total",
            multiple = FALSE)

# Update variable selections when category changes
observeEvent(input$national_category_selector, {
  
  choices <- names(national_variable_choices())
  
  updateSelectInput(session, "national_variable_selector",
                    choices = choices, 
                    selected = choices[1])
  
})

# Try debouncing, didn't fire early enough
# national_variable_selector_db <- debounce(reactive({input$national_variable_selector}), 2000)

# Selected variable for function inputs
# Output looks like "pop_total"
national_variable_selected <- reactive({ 
  
  # req(national_variable_selector_db())
  req(national_category_selected())
  
  getElement(national_variable_choices(), input$national_variable_selector)
  
})

### For debugging
# renderText({ is.null(national_category_selected()) })
# renderText({ is.null(national_variable_selected()) })
# renderText({ national_category_selected() })
# renderText({ national_variable_selected() })
# renderText({ national_variable_choices() })


### ----- Summary text  ------


# Summary text
output$national_map_summary <- renderUI({
  
  HTML(
    paste0(
      altText(national_data(), 
              national_variable_selected()),
      " Detailed information is available to the right in the interactive map (top) and table (bottom).<br><br>Source: 2017-2021 American Community Survey five-year estimates")
  )
  
})

withSpinner(uiOutput("national_map_summary"))

```

</div>

## Row {data-height=100}

<div role="region" aria-labelledby="section-national-title">

### National Map Title

```{r national-map-title, fig.alt = "Map title the selected topic."}

output$national_map_title <- renderUI({

  HTML(
      altTitle(national_variable_selected())
      
    # # Static check
    # altTitle(demographics,
    #         national_variable_selector_static)

  )

})

withSpinner(uiOutput("national_map_title"))

```

</div>

## Row

<div role="region" aria-labelledby="section-state-by-state-map-of-selected-topic">

### State-by-State Map of Selected Topic

```{r national-map, out.width = "100%", fig.align = "center", fig.cap= "A map of the United States, with each state shaded according to the quartiles described in the summary.", fig.alt= "A map of the United States, with each state shaded according to the quartiles described in the summary."}

output$national_map <- renderUI({
  
  withSpinner(plotOutput("national_ggmap"))
  
})

uiOutput("national_map")

output$national_ggmap <- renderPlot({
  
  render_national_map(national_category_selected(),
                      national_variable_selected(), 
                      access_map_palette_selected())
  
})

# For debugging
# Static version of comparison map
# render_national_map(                          
#   "is_demographics",
#   "pwd_pct",
#   "YlOrBr"
# )

# output$national_tmap <- renderPlot({
#   #   # req(national_variable_selected(), national_category_selected(), national_data())
#   #   print("reqs filled")
#   #   print("run tmap")
#   render_national_map(national_category_selected(),
#                       national_variable_selected(),
#                       access_map_palette_selected())
#   #   
# })

```

</div>

## Row

<div role="region" aria-labelledby="section-table-of-selected-topic">

### Table of Selected Topic {.table-wrapper}

```{r national-table, fig.alt = "Data table including state-level data for variables relevant to the selected topic."}

# Get variable group based on selected variable
national_vars_in_topic <- reactive({
  
  dict_vars %>% 
    filter((!!sym(national_category_selected())) == TRUE,
           var_topic ==
             (dict_vars %>% 
                filter((!!sym(national_category_selected())) == TRUE,
                       var_readable == national_variable_selected()) %>% 
                pull(var_topic)),
           display == T) %>% 
    select(var_pretty, var_readable)
  
  # # Static check
  # national_vars_in_topic_static <- dict_vars %>%
  #   filter(is_demographics == TRUE,
  #          var_topic ==
  #          (dict_vars %>%
  #             filter(is_demographics == TRUE,
  #                    var_readable == "pwd_18_64_pct") %>%
  #             pull(var_topic))) %>%
  #   select(var_pretty, var_readable)
  
})

# Caption
cap_choices <- c("Demographics" = "is_demographics", 
                 "Community Participation" = "is_community_participation", 
                 "Community Living" = "is_community_living", 
                 "Work/Economic" = "is_work_economic")

table_caption <- reactive({
  
  paste(names(cap_choices[cap_choices == national_category_selected()]), "Table")
  
})

# Reorganize dataframe, switch to pretty names
national_data_table_friendly <- reactive({
  
  national_data() %>%
    arrange(GEOID) %>% 
    mutate("State" = paste0(NAME
                            # , " (", ABBR, ")"
    )
    ) %>% 
    select(any_of(c("State",
                    national_vars_in_topic() %>% 
                      pull(var_readable)))) %>% 
    mutate(across(-State & -ends_with("_pct"),
                  ~scales::comma(.x))) %>% 
    mutate(across(ends_with("_pct"),
                  ~scales::percent(.x, 
                                   accuracy = 0.1,
                                   scale = 1))) %>% 
    rename(!!any_of(national_vars_in_topic() %>% 
                      deframe())) %>%
    select(State, starts_with("Population"), starts_with("Percent"), everything())
  
  # # Static check
  # table_friendly <- demographics %>%
  #   mutate("State" = paste0(NAME
  #                           # " (", ABBR, ")"
  #                           )) %>%
  #   select(any_of(c("State",
  #                   national_vars_in_topic_static %>%
  #                     pull(var_readable)))) %>%
  #   mutate(across(-State & -ends_with("_pct"),
  #                 ~scales::comma(.x))) %>%
  #   mutate(across(ends_with("_pct"),
  #                 ~scales::percent(.x,
  #                                  accuracy = 0.1,
  #                                  scale = 1))) %>%
  #   rename(!!any_of(national_vars_in_topic_static %>%
  #                     deframe()))
  
})

# UI Output
output$national_table <- renderUI({ 
  
  # This is incredibly hacky
  # But I can't find a better way to make these
  # tables accessible at this point in time
  HTML(
    tableHTML(national_data_table_friendly() %>% 
                mutate(State = paste0(State, "a")), rownames = F, class = "table_national") %>% 
      # Essentially, this respecifies the first column as a column of table headers. See link below
      # https://www.w3.org/WAI/tutorials/tables/two-headers/
      replace_html('<td id="tableHTML_column_1">', '<th scope="row" id="tableHTML_column_1">', replace_all = T) %>% 
      replace_html('[a-z]</td>', '</th>', replace_all = T)
  )
  
  # Static check
  # HTML(
  #   tableHTML(table_friendly %>%
  #               mutate(State = paste0(State, "a")),
  #             rownames = F, class = "table_national") %>%
  #     # Essentially, this respecifies the first column as a column of table headers. See link below
  #     # https://www.w3.org/WAI/tutorials/tables/two-headers/
  #     replace_html('<td id="tableHTML_column_1">', '<th scope="row" id="tableHTML_column_1">', replace_all = T) %>%
  #     replace_html('[a-z]</td>', '</th>', replace_all = T)
  # )
  
})

withSpinner(uiOutput("national_table"))

```

</div>

</div>

<div role="main">

# City Data

## Sidebar {.sidebar}

To explore the data select a city below. You can navigate the selection boxes using the mouse or keyboard. For keyboard users, once the box is highlighted you can press backspace and begin typing the selection into the box. A state must be selected first.


```{r city-sidebar}

# Define inputs, restrict to cities in database

state_choices <- tibble(NAME = state.name, ABB =  state.abb) %>%
  add_row(NAME = c("District of Columbia", "Puerto Rico"),
          ABB = c("DC", "PR")) %>%
  deframe()

selectInput(inputId = "state_selector",
            label = "Select a state",
            choices = state_choices,
            selected = state_choices[13])

state_selected <- reactive({
  state_choices[which(state_choices == input$state_selector)]
})

# City choices, based on state, remove CDPs for now
city_choices <- reactive({
  
  tibble::deframe(
    dict_location_crosswalk %>%
      filter(state == state_selected(),
             !str_detect(city, " CDP")) %>%
      select(city, state, place_GEOID) %>%
      distinct(city, place_GEOID)
  ) %>%
    sort()
  
})

selectInput(inputId = "city_selector", 
            label = "Select a city", 
            choices =   tibble::deframe(
    dict_location_crosswalk %>%
      filter(state == "IL") %>%
      select(city, state, place_GEOID) %>%
      distinct(city, place_GEOID)
  ),
            selected = "1714000")

# Update variable selections when category changes
observeEvent(input$state_selector, {
  
  choices <- names(city_choices())
  
  updateSelectInput(session, "city_selector",
                    choices = choices, 
                    selected = choices[2])
  
})

city_selected <- reactive({ 
  
  # req(national_variable_selector_db())
  req(state_selected())
  
  getElement(city_choices(), input$city_selector)
  
})

### ----- Pull Census Place data for selected city -----

# Place for selected city
city_place <- reactive({
  
  city_place_full %>% 
    filter(GEOID == city_selected())
  
})

### ----- Pull Census Tract data for selected city -----

# Spatial
city_tract_sf <- reactive({
  
  # Restrict tract call to selected city
  temp_city <- dict_location_crosswalk %>% 
    filter(place_GEOID %in% city_selected()) %>% 
    pull(tract_GEOID)
  
  temp_sf <- tracts_sf %>%
    filter(t_GEOID %in% temp_city)
  
  return(temp_sf)
  
})

# Tabular
city_tract <- reactive ({
  
  temp_city <- dict_location_crosswalk %>%
    filter(place_GEOID %in% city_selected()) %>%
    pull(tract_GEOID)
  
  temp <- tracts_data %>%
    filter(GEOID %in% temp_city) 
  # # Connect and pull
  # temp_mongo_conn <- fun_mongo_connect(host_name,
  #                                      collection_name = "acs_tract_S1810",
  #                                      database_name = "ADA-PARC")
  # temp <- temp_mongo_conn$find(
  #   query = sprintf('{ "GEOID" : { "$in" : [  "%s" ] } }' ,
  #                   str_c(city_tract_sf()$t_GEOID, collapse = '", "')))
  return(temp)
  
})

```

## Row

<div role="region" aria-labelledby="section-city-summary">

### City Summary

```{r city-summary}

output$city_summary <- renderUI({
  
  # Overview text
  city_summary_text <- paste0(
    "<h4>",  
    city_place() %>% 
      mutate(NAME = str_replace_all(NAME, pattern = " (city|village|municipality|town), ", replacement = ", ")) %>% 
      pull(NAME), "</h4>",
    "Based on ACS 2021 5-Year Estimates, <b>", city_place() %>% 
      pull(S1810_C02_001_estimate) %>% 
      scales::comma(.), "</b> of the city's <b>", 
    city_place() %>% 
      pull(S1810_C01_001_estimate) %>% 
      scales::comma(.), "</b> residents (<b>", 
    city_place() %>% 
      pull(S1810_C03_001_estimate), "%</b>) are people with disabilities.<br><h5>People with Disabilities - Summary Tables</h5>")
  
  # Summary tables side by side
  # Create individual summary tables
  # Demographics
  city_summary_demo <- city_place() %>%
    mutate("Other" = S1810_C02_006_estimate + S1810_C02_008_estimate + 
             S1810_C02_009_estimate + S1810_C02_010_estimate) %>% 
    select("White" = S1810_C02_011_estimate,
           "Black" = S1810_C02_005_estimate,
           "Hispanic" = S1810_C02_012_estimate,
           "Asian" = S1810_C02_007_estimate,
           Other,
           "Total" = S1810_C02_001_estimate) %>% 
    mutate(across(-Total,
                  ~ paste0(comma(., accuracy = 1), 
                           " (",  percent(. / Total, 
                                          accuracy = 0.1), ")"))) %>%
    mutate(Total = paste0(comma(Total, 
                                accuracy = 1),
                          "</b>")) %>%
    rename("<b>Total" = Total) %>% 
    pivot_longer(everything(),
                 names_to = "Race/Ethnicity",
                 values_to = "PWD (%)") %>% 
    mutate("Bullets" = paste0('<li>', `Race/Ethnicity`, " &mdash; ",
                              `PWD (%)`, '</li>')) %>%
    
    pull(Bullets) %>% 
    str_c(collapse = "")
  
  # Community Participation
  city_summary_cp <- city_place() %>%
    transmute("Car" = 
                paste0(comma(S1811_C02_032_estimate * 
                               ((S1811_C02_033_estimate +
                                   S1811_C02_034_estimate) / 100),
                             accuracy = 1),
                       " (", comma((S1811_C02_033_estimate +
                                      S1811_C02_034_estimate),
                                   accuracy = 0.1), "%)"),
              "Transit" = 
                paste0(comma(S1811_C02_032_estimate * 
                               (S1811_C02_035_estimate / 100),
                             accuracy = 1),
                       " (", comma(S1811_C02_035_estimate,
                                   accuracy = 0.1), "%)"),
              
              "Walk or Bike" = 
                paste0(comma(S1811_C02_032_estimate * 
                               ((S1811_C02_036_estimate +
                                   S1811_C02_037_estimate) / 100),
                             accuracy = 1),
                       " (", comma((S1811_C02_036_estimate +
                                      S1811_C02_037_estimate),
                                   accuracy = 0.1), "%)"),
              "Work from Home" = 
                paste0(comma(S1811_C02_032_estimate * 
                               (S1811_C02_038_estimate / 100),
                             accuracy = 1),
                       " (", comma((S1811_C02_038_estimate),
                                   accuracy = 0.1), "%)"),
              "<b>Total" = 
                paste0(comma(S1811_C02_032_estimate, 
                             accuracy = 1),
                       "</b>")) %>% 
    pivot_longer(everything(),
                 names_to = "Commute, Workers 16+",
                 values_to = "PWD (%)") %>% 
    mutate("Bullets" = paste0('<li>', `Commute, Workers 16+`, " &mdash; ",
                              `PWD (%)`, '</li>')) %>%
    
    pull(Bullets) %>% 
    str_c(collapse = "")
  
  # Work/Economic
  city_summary_we <- city_place() %>%
    transmute("Employed" = 
                paste0(comma(S1811_C02_004_estimate, accuracy = 1),
                       " (", S1811_C02_002_estimate, "%)"),
              "Not in Labor Force" = 
                paste0(comma((S1811_C02_001_estimate - S1811_C02_004_estimate), accuracy = 1), 
                       " (", S1811_C02_003_estimate, "%)"),
              "<b>Total" = 
                paste0(comma(S1811_C02_001_estimate, accuracy = 1),
                       "</b>")) %>%
    pivot_longer(everything(),
                 names_to = "Employment, 16+",
                 values_to = "PWD (%)") %>% 
    mutate("Bullets" = paste0('<li>', `Employment, 16+`, " &mdash; ",
                              `PWD (%)`, '</li>')) %>%
    
    pull(Bullets) %>% 
    str_c(collapse = "")
  
  # Place dataframes in 3 columns side-by-side
  city_summary_tables <- paste0('<div class = "row">',
                                '<div class = "col-md-4">',
                                '<b>Race/Ethnicity</b><ul>',
                                city_summary_demo,
                                '</ul></div>',
                                '<div class = "col-md-4">',
                                '<b>Commute, Workers 16+</b><ul>',
                                city_summary_cp,
                                '</ul></div>',
                                '<div class = "col-md-4">',
                                '<b>Employment, 16+</b><ul>',
                                city_summary_we,
                                '</ul></div>',
                                '</div>')
  
  
  
  # UI Output
  HTML(paste(city_summary_text, city_summary_tables, sep = ""))
  
})

withSpinner(uiOutput("city_summary"))

```

</div>

## Row

<div role="region" aria-labelledby="section-people-with-disabilities-map">

### People With Disabilities Map

```{r city-pwd-map, fig.alt="Map of people with disabilities by census tract in the selected city", context="server"}

# Palette
pal_city <- reactive ({
  if(length(pull(city_tract(), S1810_C02_001_estimate)) < 4) {
    colorNumeric(palette = access_map_palette_selected(),
                 domain = pull(city_tract(), S1810_C02_001_estimate))
  } else {
    colorQuantile(palette = access_map_palette_selected(),
                  domain = pull(city_tract(), S1810_C02_001_estimate),
                  n = 4)
  }
  
})

# Tract map
output$snapshotmap <- renderLeaflet({
  
  data <- left_join(city_tract_sf(),
                    city_tract() %>% select(GEOID, S1810_C02_001_estimate),
                    by = c("t_GEOID" = "GEOID")) 
  
  leaflet(data) %>%
    clearShapes() %>%
    addProviderTiles(providers$Esri, group = "Esri") %>%
    addProviderTiles(providers$CartoDB.Positron, group = "CartoDB") %>%
    addResetMapButton() %>%
    addPolygons(stroke = TRUE, color = "#444444",
                weight = 1, smoothFactor = 0,
                fillColor = ~pal_city()(S1810_C02_001_estimate),
                fillOpacity = 0.5,
                layerId = ~t_GEOID) %>%
    addLegend(position = "topright", pal = pal_city(),
              values = ~S1810_C02_001_estimate,
              labFormat =  function(type, cuts, p) {
                n = length(cuts)
                paste0(as.numeric(cuts)[-n], " &ndash; ", as.numeric(cuts)[-1])
              },
              title = "PWD") %>%
    addLayersControl(position = "bottomright",
                     baseGroups = c("Esri", "CartoDB"),
                     options = layersControlOptions(collapsed = FALSE)) %>%
    addSearchOSM(options = searchOptions(autoCollapse = FALSE, minLength = 3,
                                         position = "topleft", zoom = 15,
                                         autoResize = FALSE,
                                         hideMarkerOnCollapse = TRUE))
  
})

# # Click event for the map
# click_snapshotmap <- eventReactive(input$snapshotmap_shape_click, {
#   
#   x <- input$snapshotmap_shape_click
#   y <- x$id
#   
#   return(y)
#   
# })

# # Add the clicked state to the map, and remove when a new one is clicked
# observe({
#   
#   req(click_snapshotmap())
#   
#   snapshotmap <- leafletProxy("snapshotmap") %>%
#     removeShape("highlight_tract") %>%
#     addPolygons(data = city_tract_sf()[city_tract_sf()$GEOID == click_snapshotmap(), ], 
#                 fill = FALSE, weight = 3,
#                 color = "#000000", opacity = 1, layerId = "highlight_tract")
#   
# })

withSpinner(leafletOutput("snapshotmap"))


```

</div>

</div>

<!-- ## Row -->

<!-- ### City in Context -->

<!-- ```{r city context plots, fig.alt=c("Scatterplot of the percent of people with disabilities (y-axis) versus total population (x-axis)", "Scatterplot of the percent of people with disabilities with a bachelor's degree or higher (y-axis) versus people with disabilities population (x-axis)", "Scatterplot of people with disabilities employment rate (y-axis) versus people with disabilities population (x-axis)"), context="server"} -->

<!-- # =============== -->
<!-- # Demographics -->
<!-- # =============== -->

<!-- # Definition -->
<!-- output$city_demo_plot <- renderPlotly({ -->

<!--   # Plot -->
<!--   gg <- city_place_full %>% -->
<!--     mutate("NAME" = str_replace_all( -->
<!--       NAME,  -->
<!--       pattern = " (city|village|municipality|town), ", -->
<!--       replacement = ", ")) %>%  -->
<!--     select(GEOID, -->
<!--            NAME,  -->
<!--            "pwd" = S1810_C02_001_estimate, -->
<!--            "total_population" = S1810_C01_001_estimate, -->
<!--            "pwd_pct" = S1810_C03_001_estimate) %>% -->
<!--     ggplot(aes(text = paste0("City: ", NAME,  -->
<!--                              "<br>PWD: ", scales::comma(pwd, -->
<!--                                                         accuracy = 1),  -->
<!--                              " (", pwd_pct, "%)", -->
<!--                              "<br>Total Pop.: ",  -->
<!--                              scales::comma(total_population, -->
<!--                                            accuracy = 1)))) + -->
<!--     geom_point(stat = "identity", -->
<!--                alpha = 0.8, position = "jitter", -->
<!--                aes(x = total_population, y = pwd_pct)) + -->
<!--     gghighlight(GEOID == input$city_selector) + -->
<!--     labs(x = "Total Population",  -->
<!--          y = "PWD (%)", -->
<!--          title = "People with Disabilities (%) vs. Total Population") + -->
<!--     scale_x_log10(labels = scales::comma) + -->
<!--     scale_y_continuous(labels = function(x) paste0(x, "%")) + -->
<!--     ggplot_fill_selected() + -->
<!--     ggplot_theme_selected() + -->
<!--     theme(legend.position = "top") -->

<!--   # Interactive plotly settings -->
<!--   plotly::ggplotly(gg, tooltip = "text") %>%  -->
<!--     plotly::layout( -->
<!--       height = 280, -->
<!--       margin = list(l = 25, t = 25, b = 90), -->
<!--       xaxis = list(title = list(text = "Total Population", -->
<!--                                 standoff = 5, -->
<!--                                 font = list(size = 14)), -->
<!--                    tickfont = list(size = 12)), -->
<!--       yaxis = list(title = list(text = "PWD (%)", -->
<!--                                 standoff = 5, -->
<!--                                 font = list(size = 14)), -->
<!--                    tickfont = list(size = 12)), -->
<!--       title = list(text = "People with Disabilities (%) vs. Total Population", -->
<!--                    font = list(size = 16), -->
<!--                    yref = "paper", -->
<!--                    y = 1, -->
<!--                    yanchor = "bottom"), -->
<!--       font = list(size = 10) -->
<!--     ) -->

<!-- }) -->

<!-- # =============== -->
<!-- # Community Participation -->
<!-- # =============== -->

<!-- output$city_cp_plot <- renderPlotly({ -->

<!--   # Plot -->
<!--   gg <- city_place_full %>% -->
<!--     mutate("NAME" = str_replace_all( -->
<!--       NAME,  -->
<!--       pattern = " (city|village|municipality|town), ", -->
<!--       replacement = ", ")) %>%   -->
<!--     select(GEOID, -->
<!--            NAME, -->
<!--            "pwd_25_over" = S1811_C02_039_estimate, -->
<!--            "pwd_bachelors" = S1811_C02_043_estimate) %>%  -->
<!--     ggplot(aes(text = paste0("City: ", NAME,  -->
<!--                              "<br>PWD Bachelor's or Higher: ", pwd_bachelors, "%", -->
<!--                              "<br>PWD 25+: ", scales::comma(pwd_25_over, -->
<!--                                                             accuracy = 1)))) + -->
<!--     geom_point(stat = "identity", -->
<!--                alpha = 0.8, position = "jitter", -->
<!--                aes(x = pwd_25_over, y = pwd_bachelors)) + -->
<!--     gghighlight(GEOID == input$city_selector) + -->
<!--     labs(x = "PWD, 25 or Older",  -->
<!--          y = "Bachelor's Degree or Higher (%)", -->
<!--          title = "Bachelor's Degree or Higher (%) vs. PWD Population 25 or Older") + -->
<!--     scale_x_log10(labels = scales::comma) + -->
<!--     scale_y_continuous(labels = function(x) paste0(x, "%")) + -->
<!--     ggplot_fill_selected() + -->
<!--     ggplot_theme_selected() + -->
<!--     theme(legend.position = "top") -->

<!--   # Interactive plotly settings -->
<!--   plotly::ggplotly(gg, tooltip = "text") %>%  -->
<!--     plotly::layout( -->
<!--       height = 280, -->
<!--       margin = list(l = 25, t = 25, b = 90), -->
<!--       xaxis = list(title = list(text = "PWD, 25 or Older", -->
<!--                                 standoff = 5, -->
<!--                                 font = list(size = 14)), -->
<!--                    tickfont = list(size = 12)), -->
<!--       yaxis = list(title = list(text = "Bachelor's Degree or Higher (%)", -->
<!--                                 standoff = 5, -->
<!--                                 font = list(size = 14)), -->
<!--                    tickfont = list(size = 12)), -->
<!--       title = list(text = "Bachelor's Degree or Higher (%) vs. PWD Population 25 or Older", -->
<!--                    font = list(size = 16), -->
<!--                    yref = "paper", -->
<!--                    y = 1, -->
<!--                    yanchor = "bottom"), -->
<!--       font = list(size = 10) -->
<!--     ) -->

<!-- }) -->

<!-- # =============== -->
<!-- # Work/Economic -->
<!-- # =============== -->

<!-- # Definition -->
<!-- output$city_we_plot <- renderPlotly({ -->

<!--   # Plot -->
<!--   gg <- city_place_full %>% -->
<!--     mutate("NAME" = str_replace_all( -->
<!--       NAME,  -->
<!--       pattern = " (city|village|municipality|town), ", -->
<!--       replacement = ", ")) %>%  -->
<!--     select(GEOID, -->
<!--            NAME, -->
<!--            "pwd_employed" = S1811_C02_004_estimate, -->
<!--            "pwd" = S1811_C02_001_estimate, -->
<!--            "pwd_employed_pct" = S1811_C02_002_estimate) %>%  -->
<!--     ggplot(aes(text = paste0("City: ", NAME,  -->
<!--                              "<br>PWD Employed: ",  -->
<!--                              scales::comma(pwd_employed, -->
<!--                                            accuracy = 1),  -->
<!--                              " (", pwd_employed_pct, "%)", -->
<!--                              "<br>PWD ", scales::comma(pwd, -->
<!--                                                        accuracy = 1)))) + -->
<!--     geom_point(stat = "identity", -->
<!--                alpha = 0.8, position = "jitter", -->
<!--                aes(x = pwd, y = pwd_employed_pct)) + -->
<!--     gghighlight(GEOID == input$city_selector) + -->
<!--     labs(x = "People with Disabilities",  -->
<!--          y = "PWD Employment Rate (%)", -->
<!--          title = "PWD Employment Rate (%) vs. PWD Population") + -->
<!--     scale_x_log10(labels = scales::comma) + -->
<!--     scale_y_continuous(labels = function(x) paste0(x, "%")) + -->
<!--     ggplot_fill_selected() + -->
<!--     ggplot_theme_selected() + -->
<!--     theme(legend.position = "top") -->

<!--   # Interactive plotly settings -->
<!--   plotly::ggplotly(gg, tooltip = "text") %>%  -->
<!--     plotly::layout( -->
<!--       height = 280, -->
<!--       margin = list(l = 25, t = 25, b = 90), -->
<!--       xaxis = list(title = list(text = "PWD Population", -->
<!--                                 standoff = 5, -->
<!--                                 font = list(size = 14)), -->
<!--                    tickfont = list(size = 12)), -->
<!--       yaxis = list(title = list(text = "PWD Employment Rate (%)", -->
<!--                                 standoff = 5, -->
<!--                                 font = list(size = 14)), -->
<!--                    tickfont = list(size = 12)), -->
<!--       title = list(text = "PWD Employment Rate (%) vs. PWD Population", -->
<!--                    font = list(size = 16), -->
<!--                    yref = "paper", -->
<!--                    y = 1, -->
<!--                    yanchor = "bottom"), -->
<!--       font = list(size = 10) -->
<!--     ) -->

<!-- }) -->

<!-- # Tab panel output -->
<!-- tabsetPanel(type = "tabs", -->
<!--             tabPanel("Demographics", -->
<!--                      plotlyOutput("city_demo_plot")), -->
<!--             tabPanel("Community Participation", -->
<!--                      plotlyOutput("city_cp_plot")), -->
<!--             tabPanel("Work/Economic", -->
<!--                      plotlyOutput("city_we_plot"))) -->

<!-- ``` -->

<!-- ### Characteristics of Selected Tract (Click on Map to Show Table) {.table-wrapper} -->

<!-- ```{r, metro snapshot tract table} -->

<!-- # Reconfigure tract data for table -->
<!-- city_table_data <- reactive({ -->

<!--   # Select tract -->
<!--   temp <- city_tract()[city_tract()$GEOID == click_snapshotmap(), ]  -->

<!--   # Static check -->
<!--   # Census Tract 59.01, Montgomery County, Alabama -->
<!--   # temp_mongo_conn <- fun_mongo_connect(host_name = "host_dev", -->
<!--   #                                      collection_name = "acs_tract_S1810", -->
<!--   #                                      database_name = "ADA-PARC") -->
<!--   # temp <- temp_mongo_conn$find( -->
<!--   #   query = sprintf('{ "GEOID" : { "$in" : ["01101005901" ] } }')) -->

<!--   # Value and percent (Remove White and Hispanic, reorder Race topic) -->
<!--   temp_values <- temp %>%  -->
<!--     select(GEOID:NAME, matches("_C02_")) %>% -->
<!--     # Values -->
<!--     pivot_longer(cols = -c(GEOID:NAME), -->
<!--                  names_to = c("variable", ".value"), -->
<!--                  names_pattern = "(.*)_(.*)") %>%  -->
<!--     # Percent -->
<!--     mutate("pct" = format(round((estimate / max(estimate)) * 100, -->
<!--                                 digits = 1), -->
<!--                           nsmall = 1)) %>%  -->
<!--     mutate("pct" = replace_na(pct, 0)) %>%  -->
<!--     # Variable order -->
<!--     filter(!variable %in% c("S1810_C02_004")) %>%  -->
<!--     mutate("variable" = fct_relevel( -->
<!--       variable, -->
<!--       c("S1810_C02_001",  -->
<!--         # Gender -->
<!--         "S1810_C02_002", "S1810_C02_003", -->
<!--         # Race/Ethnicity -->
<!--         "S1810_C02_011", "S1810_C02_005", "S1810_C02_012", -->
<!--         "S1810_C02_007", "S1810_C02_006", "S1810_C02_008", -->
<!--         "S1810_C02_009", "S1810_C02_010", -->
<!--         # Age -->
<!--         "S1810_C02_013", "S1810_C02_014", "S1810_C02_015", -->
<!--         "S1810_C02_016", "S1810_C02_017", "S1810_C02_018"))) %>%  -->
<!--     arrange(variable) -->

<!--   # Output -->
<!--   temp_values %>% -->
<!--     left_join(., -->
<!--               dict_vars %>%  -->
<!--                 select("category" = var_topic, -->
<!--                        "label" = var_pretty, -->
<!--                        "variable" = var_database), -->
<!--               by = "variable") %>% -->
<!--     # Label -->
<!--     mutate("label" = str_remove_all(label,  -->
<!--                                     "Total Persons with Disabilities, ")) %>% -->
<!--     mutate("label" = case_when(variable == "S1810_C02_001" ~ -->
<!--                                  "People with Disabilities", -->
<!--                                variable == "S1810_C02_011" ~ -->
<!--                                  "White alone", -->
<!--                                variable == "S1810_C02_012" ~ -->
<!--                                  "Hispanic or Latino", -->
<!--                                TRUE ~ label)) %>% -->
<!--     mutate("category" = str_to_title(category)) %>%  -->
<!--     select(GEOID, NAME, category, variable, label, -->
<!--            estimate, moe, pct)  -->

<!-- }) -->

<!-- # Table -->
<!-- renderUI({  -->

<!--   # Req -->
<!--   req(nrow(city_table_data()) > 0) -->

<!--   HTML( -->

<!--     kbl(x = city_table_data() %>% -->
<!--           mutate("output_est" = paste0(comma(estimate, -->
<!--                                              accuracy = 1),  -->
<!--                                        " (", pct, "%)"), -->
<!--                  "output_moe" = paste0("(Â±",  -->
<!--                                        comma(moe, -->
<!--                                              accuracy = 1), -->
<!--                                        ")")) %>%  -->
<!--           mutate(across(everything(),  -->
<!--                         ~cell_spec(., "html", -->
<!--                                    color = ifelse(moe >= estimate,  -->
<!--                                                   "red", "black")))) %>% -->
<!--           select("Variable" = label, "Est" = output_est,  "MOE" = output_moe), -->
<!--         caption = city_table_data() %>% head(1) %>% pull(NAME), -->
<!--         escape = FALSE, -->
<!--         table.attr = "style='width:100%;'") %>%  -->
<!--       pack_rows(index = table( -->
<!--         fct_inorder(city_table_data()$category))) %>%  -->
<!--       kable_styling(bootstrap_options = c("striped", "hover",  -->
<!--                                           "condensed"), -->
<!--                     full_width = TRUE) -->

<!--   ) }) -->

<!-- ``` -->

<!-- Comparison {data-navmenu="By City"} -->

<!-- ====================================================================== -->

<!-- Sidebar {.sidebar} -->

<!-- ----------------------------------------------------------------------- -->

<!-- <br> -->

<!-- ```{r } -->

<!-- # Same for the other city-level data we have available (i.e. community_participation and work_economic. recommend flopping the naming convention here to metro_demo_data to keep things organized, i should probably do that for national as well) -->

<!-- ``` -->

<!-- ```{r } -->

<!-- # Define inputs -->

<!-- # City -->

<!-- selectizeInput(inputId = "compare",  -->

<!--                label = "Select Cities to Compare",  -->

<!--                choices = city_tract() %>% select(metro_state), -->

<!--                multiple = TRUE, -->

<!--                options = list( -->

<!--                  maxItems = 3, -->

<!--                  placeholder = "select up to 3 cities" -->

<!--                ) -->

<!-- ) -->

<!-- ### I want to model something similar to the AARP website -->

<!-- ### So these three inputs would feed into the DT and then we could do a transposed table of -->

<!-- ### some subset of relevant fields for the user based on a selection -->

<!-- ``` -->

<!-- Row -->

<!-- ----------------------------------------------------------------------- -->

<!-- ### Table {.download-DT} -->

<!-- ```{r } -->

<!-- DT::renderDataTable({ -->

<!--   if(is.null(input$compare)){ -->

<!--     DT::datatable( -->

<!--       metro_demo_data %>%  -->

<!--         rename("City" = metro_state), -->

<!--       options(lengthMenu = list(c(5, 10, 20, -1), c("5", "10", "20", "All"))) -->

<!--     ) -->

<!--   }else{ -->

<!--     DT::datatable( -->

<!--       metro_demo_data %>%  -->

<!--         filter(metro_state %in% input$compare) %>%  -->

<!--         select("City" = metro_state, everything()) %>% -->

<!--         pivot_longer( -->

<!--           cols = -"City", -->

<!--           names_to = "Variable" -->

<!--         ) %>% -->

<!--         pivot_wider( -->

<!--           id_cols = Variable, -->

<!--           names_from = City -->

<!--         ) %>% -->

<!--         select(" " = Variable, everything()), -->

<!--       options (pageLength = 50) -->

<!--     ) -->

<!--   } -->

<!-- }) -->

<!-- ``` -->

<!-- Explore {data-navmenu="By Metro"} -->

<!-- ====================================================================== -->

<!-- Sidebar {.sidebar} -->

<!-- ----------------------------------------------------------------------- -->

<!-- <br> -->

<!-- ```{r metro explore sidebar} -->

<!-- # Define inputs -->

<!-- # Metro -->

<!-- selectizeInput(inputId = "metro_explore_select",  -->

<!--                label = "Select Metro Areas to explore",  -->

<!--                choices = metro_demo_data %>% select(metro_state),  -->

<!--                multiple = TRUE,  -->

<!--                options = list("plugins" = list("remove_button"),  -->

<!--                               "create" = TRUE, -->

<!--                               "persist" = FALSE)) -->

<!-- # Variable of interest -->

<!-- selectizeInput(inputId = "var_explore_select",  -->

<!--                label = "Select a demographic variable",  -->

<!--                choices = names(metro_demo_data %>% select(pwd:percent_pwd_female)),  -->

<!--                selected = names(metro_demo_data %>% select(pwd)), -->

<!--                multiple = TRUE,  -->

<!--                options = list("plugins" = list("remove_button"),  -->

<!--                               "create" = TRUE, -->

<!--                               "persist" = FALSE)) -->

<!-- ``` -->

<!-- Row -->

<!-- ----------------------------------------------------------------------- -->

<!-- ### Table {.download-DT} -->

<!-- ```{r metro explore table} -->

<!-- DT::renderDataTable({ -->

<!--   if(is.null(input$metro_explore_select)){ -->

<!--     DT::datatable( -->

<!--       metro_demo_data %>%  -->

<!--         rename("City" = metro_state), -->

<!--       options(list(scrollX = "200px", -->

<!--                    pageLength = 5, -->

<!--                    lengthMenu = list(c(5, 10, 20, -1), c("5", "10", "20", "All")))) -->

<!--     ) -->

<!--   }else{ -->

<!--     DT::datatable( -->

<!--       metro_demo_data %>%  -->

<!--         filter(metro_state %in% input$metro_explore_select) %>%  -->

<!--         select("City" = metro_state, input$var_explore_select), -->

<!--       options(list(scrollX = "200px",  -->

<!--                    pageLength = 5, -->

<!--                    lengthMenu = list(c(5, 10, 20, -1), c("5", "10", "20", "All")))) -->

<!--     ) -->

<!--   } -->

<!-- }) -->

<!-- ``` -->

<!-- Row -->

<!-- ----------------------------------------------------------------------- -->

<!-- ### Selected Variables by Metro -->

<!-- ```{r metro overview chart} -->

<!-- output$metro_explore_plot <- renderPlotly({ -->

<!--   # Require input action and non-null variable before plotting chart -->

<!--   req(input$metro_explore_select) -->

<!--   req(!is.null(input$var_explore_select)) -->

<!--   # Plot -->

<!--   plotly::ggplotly( -->

<!--     metro_demo_data %>% -->

<!--       filter(metro_state %in% input$metro_explore_select) %>% -->

<!--       select(metro_state, input$var_explore_select) %>% -->

<!--       pivot_longer(cols = -metro_state, names_to = "variable", values_to = "value") %>% -->

<!--       mutate(variable = str_replace_all(variable, "_", " "), -->

<!--              value = as.numeric(value)) %>% -->

<!--       ggplot(aes(x = variable, y = value, fill = metro_state)) + -->

<!--       geom_bar(stat = "identity", width = 0.8, -->

<!--                position = position_dodge2(width = 0.6, preserve = "single")) + -->

<!--       labs(x = "Variable", y = "Value") + -->

<!--       scale_y_comma() + -->

<!--       coord_flip() + -->

<!--       ggplot_fill_selected() + -->

<!--       ggplot_theme_selected() + -->

<!--       theme(legend.position = "top") -->

<!--   ) -->

<!-- }) -->

<!-- plotlyOutput("metro_explore_plot") -->

<!-- ``` -->

<!-- # Download Data -->

<!-- ## Row -->

<!-- <div role="main"> -->

<!-- ###   -->

<!-- ```{r download-data-body} -->

<!-- ### ----- National Data ----- -->

<!-- # Text -->
<!-- h5("Download National Data:") -->

<!-- # Download button -->
<!-- downloadButtonRmd(outputId = "download_data_national_button", -->
<!--                   label = "Download", -->
<!--                   style = "vertical-align: middle; height: 40px !important; width: 125px !important;") -->

<!-- # Download file  -->
<!-- output$download_data_national_button <- downloadHandler( -->

<!--   filename = function() { -->
<!--     paste0("ADA-PARC_National_Data_Download_", -->
<!--            format(Sys.time(), "%Y-%m-%d_%I%M%p"), -->
<!--            ".xlsx") -->
<!--   }, -->
<!--   content = function(file) { -->
<!--     openxlsx::write.xlsx( -->
<!--       list("Demographics" = demographics %>%  -->
<!--              arrange(GEOID),  -->
<!--            "Community Participation" = community_participation %>%  -->
<!--              arrange(GEOID),  -->
<!--            "Community Living" = community_living %>%  -->
<!--              arrange(GEOID),  -->
<!--            "Work-Economic" = work_economic %>%  -->
<!--              arrange(GEOID), -->
<!--            "Lookup" = dict_vars %>% -->
<!--              filter((is_demographics == TRUE |  -->
<!--                        is_community_living == TRUE | -->
<!--                        is_community_participation == TRUE | -->
<!--                        is_work_economic == TRUE)) %>%  -->
<!--              select("variable_key" = var_readable,  -->
<!--                     "variable_label" = var_pretty,  -->
<!--                     is_demographics:is_work_economic)), -->
<!--       file) -->
<!--   } -->
<!-- ) -->

<!-- ``` -->

<!-- </div> -->

# Download Fact Sheets

## Row

<div role="main">

###  

```{r download-fact-sheets-body}

# Read in dataframe of national factsheets and links
download_factsheet_national <- 
  read_csv(str_c(here::here(),
                 "/factsheet_national/dashboard_factsheet_national.csv"))

# Create accessible hyperlinks
download_factsheet_national <- download_factsheet_national %>% 
  mutate("hyperlink" = str_c('<a href="',
                             output_file,
                             '" target="_blank">',
                             national_dropdown_label,
                             '</a>')) %>% 
  select("Fact Sheets Available" = hyperlink)

# Create kable table
kbl(x = download_factsheet_national,
    escape = FALSE,
    caption = "Download National Fact Sheets") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                position = "left")

```

</div>

# Accessibility

<div role="main">

###  {.long-row}

```{r accessibility-page-body}

# Map palette
access_map_palette_choices <- list(
  "Yellow-Orange-Brown" = "YlOrBr", 
  "Yellow-Orange-Red" = "YlOrRd", 
  "Green-Blue" = "GnBu")

selectInput(inputId = "access_map_palette",
            label = h5("Select a color palette for maps:"),
            choices = names(access_map_palette_choices),
            selected = "Yellow-Orange-Brown")

access_map_palette_selected <- reactive({
  access_map_palette_choices[[input$access_map_palette]] })

# GGplot themes and colors
access_ggplot_theme_choices <- list(
  "The Economist" = list(theme_economist(), scale_fill_economist(), scale_color_economist()),
  "Five Thirty Eight" = list(theme_fivethirtyeight(), scale_fill_economist(), scale_color_fivethirtyeight()),
  "Highcharts" = list(theme_hc(), scale_fill_hc(), scale_color_hc()),
  "Ipsum" = list(theme_ipsum(), scale_fill_colorblind(), scale_color_colorblind()),
  "Light" = list(theme_light(), scale_fill_colorblind(), scale_color_colorblind()),
  "Minimal" = list(theme_minimal(),scale_fill_ordinal(), scale_color_ordinal()),
  "Stata" = list(theme_stata(), scale_fill_stata(), scale_color_stata()))

# Hide selector for now since city data plots are excluded
# selectInput(inputId = "access_ggplot_theme", 
#             label = h5("Select a theme for plots:"), 
#             choices = names(access_ggplot_theme_choices),
#             selected = "Ipsum")

ggplot_theme_selected <- reactive({ access_ggplot_theme_choices[[input$access_ggplot_theme]][1] })
ggplot_fill_selected <- reactive({ access_ggplot_theme_choices[[input$access_ggplot_theme]][2] }) 
ggplot_color_selected <- reactive({ access_ggplot_theme_choices[[input$access_ggplot_theme]][3] }) 

```

</div>

<!-- Custom Javascript  -->

```{=html}
<script>
$("body").on("shown.bs.tab", "a[data-toggle='tab']", function(e) {
Shiny.setInputValue("active_tab", $(e.target).parent().index());
})
</script>
```

<!-- CSS for dashboard  -->

```{=html}
<style type="text/css">

/* #################### */
/* Fonts */
/* #################### */

/* Headers */
h2,h3,h4,h5 { 
font-weight: bold;
}

/* Section title color */
h3 { 
color: black;
}

/* #################### */
/* Coloring */
/* #################### */

/* Leaflet border */
.leaflet .legend i{
border-left:1px solid #000000;
border-right:1px solid #000000;
border-top:1px solid #000000;
border-bottom:1px solid #000000;
}

/* Leaflet background */
.leaflet-container {
background: #ddd;
}

/* Section dividers */
.section-divider { 
background-color: #CCCCCC;
color: #000000;
}

/* Selector widget Active Option */
.item {
background: white !important;
color: black !important;
}
.selectize-dropdown-content .active {
background: #EFEFEF !important;
color: black !important;
border-left:1px solid #000000;
border-right:1px solid #000000;
border-top:1px solid #000000;
border-bottom:1px solid #000000;
}

/* Kable caption colors (darken to meet contrast requirements) */
caption {
color: black;
font-weight: bold;
}


/* #################### */
/* Containers */
/* #################### */

/* Set max length for dropdowns */
.selectize-dropdown-content {
padding: 10px;
}

/* Allow dropdowns to be visible for short containers */
#access_ggplot_theme+ div>.selectize-dropdown, #access_map_palette+ div>.selectize-dropdown {
position: static;
}

/* Have dropdowns display on top of Leaflet */
.selectize-dropdown {
z-index: 10000;
overflow-y: auto;
}

/* Scroll overflow for tables */
.table-wrapper {
overflow-x: scroll;
overflow-y: scroll;
}

</style>
```
